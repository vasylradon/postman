{
  "info": {
    "_postman_id": "5118a8ff-f0ab-4499-997b-3993a05c8bc2",
    "name": "Caremetx Auto Task - e-Eligibility Verification",
    "description": "Automated tests that orchestrate setup, manual follow-up completion, and downstream validation for the e-Eligibility Verification auto task scenarios.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auto Task - e-Eligibility Verification",
      "description": "Scenarios that validate the e-Eligibility Verification auto task responses across commercial, Medicare, no coverage, multiple coverage, and failure conditions.",
      "item": [
        {
          "name": "Happy Path - Commercial Coverage",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const expectation = {",
                  "        \"expectedCoverageCount\": 1,",
                  "        \"expectedCoverageTypes\": [",
                  "            \"primary\"",
                  "        ],",
                  "        \"expectedInsuranceNames\": [",
                  "            \"insurance\"",
                  "        ],",
                  "        \"expectFailure\": false",
                  "    };",
                  "const scenarioConfig = {",
                  "    key: 'happy',",
                  "    firstName: 'DEFAULT',",
                  "    expectation",
                  "};",
                  "",
                  "const timestamp = Date.now();",
                  "const suffix = timestamp.toString().slice(-5);",
                  "const randomId = Math.floor(Math.random() * 9000000) + 1000000;",
                  "const patientLastName = `Eligibility${suffix}`;",
                  "const patientEmail = `auto-task-${scenarioConfig.key}-${suffix}@example.com`;",
                  "const patientPhone = `502${(Math.floor(Math.random() * 9000000) + 1000000).toString().padStart(7, '0')}`;",
                  "const physicianNpi = `${Math.floor(Math.random() * 9000000000) + 1000000000}`;",
                  "const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Eligibility Way`;",
                  "const facilityZip = `${Math.floor(Math.random() * 90000) + 10000}`;",
                  "",
                  "pm.collectionVariables.set('autoTaskScenarioConfig', JSON.stringify(scenarioConfig));",
                  "pm.collectionVariables.set('autoTaskScenarioKey', scenarioConfig.key);",
                  "pm.collectionVariables.set('autoTaskSeedTimestamp', String(timestamp));",
                  "pm.collectionVariables.set('autoTaskSuffix', suffix);",
                  "",
                  "pm.collectionVariables.set('autoTaskPatientExternalId', String(randomId));",
                  "pm.collectionVariables.set('autoTaskPatientFirstName', scenarioConfig.firstName);",
                  "pm.collectionVariables.set('autoTaskPatientLastName', patientLastName);",
                  "pm.collectionVariables.set('autoTaskPatientEmail', patientEmail);",
                  "pm.collectionVariables.set('autoTaskPatientPhone', patientPhone);",
                  "pm.collectionVariables.set('autoTaskPhysicianNpi', physicianNpi);",
                  "pm.collectionVariables.set('autoTaskPrescriptionNumber', `RX-AUTO-${timestamp}`);",
                  "pm.collectionVariables.set('autoTaskNdc', `${Math.floor(Math.random() * 90000000000) + 10000000000}`);",
                  "pm.collectionVariables.set('autoTaskFacilityAddress1', facilityAddress1);",
                  "pm.collectionVariables.set('autoTaskFacilityCity', 'Louisville');",
                  "pm.collectionVariables.set('autoTaskFacilityState', 'KY');",
                  "pm.collectionVariables.set('autoTaskFacilityStateId', '21');",
                  "pm.collectionVariables.set('autoTaskFacilityZip', facilityZip);",
                  ""
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const scenarioConfigRaw = pm.collectionVariables.get('autoTaskScenarioConfig');",
                  "let scenarioConfig = {};",
                  "try {",
                  "    scenarioConfig = scenarioConfigRaw ? JSON.parse(scenarioConfigRaw) : {};",
                  "} catch (err) {",
                  "    console.error('Failed to parse scenario config', err);",
                  "    scenarioConfig = {};",
                  "}",
                  "const scenarioKey = scenarioConfig.key || 'unknown';",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - prescription intake accepted`, function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('value');",
                  "    pm.expect(json.value).to.have.property('caseId');",
                  "    pm.expect(json.success).to.eql(true);",
                  "});",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - completes verification flow`, function (done) {",
                  "    const responseJson = pm.response.json();",
                  "    const caseId = responseJson.value && responseJson.value.caseId;",
                  "    pm.collectionVariables.set('autoTaskCaseId', caseId);",
                  "    const baseUrl = pm.variables.replaceIn('{{base_url}}');",
                  "    const authToken = pm.variables.replaceIn('{{apiKey}}');",
                  "    if (!caseId) {",
                  "        pm.expect.fail('Case identifier missing from prescription intake response.');",
                  "        return done();",
                  "    }",
                  "    if (!baseUrl || !authToken) {",
                  "        pm.expect.fail('Environment variables base_url or apiKey are not configured.');",
                  "        return done();",
                  "    }",
                  "    const patientFirstName = pm.collectionVariables.get('autoTaskPatientFirstName');",
                  "    const patientLastName = pm.collectionVariables.get('autoTaskPatientLastName');",
                  "",
                  "    const toHeaderArray = (extraHeaders = {}) => {",
                  "        const headers = [",
                  "            { key: 'Authorization', value: authToken }",
                  "        ];",
                  "        Object.keys(extraHeaders).forEach(key => {",
                  "            headers.push({ key, value: extraHeaders[key] });",
                  "        });",
                  "        return headers;",
                  "    };",
                  "",
                  "    const send = (options) => new Promise((resolve, reject) => {",
                  "        const requestOptions = {",
                  "            url: options.url,",
                  "            method: options.method || 'GET',",
                  "            header: toHeaderArray(options.headers || {})",
                  "        };",
                  "        if (options.body !== undefined) {",
                  "            const rawBody = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);",
                  "            requestOptions.body = { mode: 'raw', raw: rawBody };",
                  "        }",
                  "        pm.sendRequest(requestOptions, (err, res) => {",
                  "            if (err) {",
                  "                reject(err);",
                  "                return;",
                  "            }",
                  "            if (!res) {",
                  "                reject(new Error('No response object returned.'));",
                  "                return;",
                  "            }",
                  "            resolve(res);",
                  "        });",
                  "    });",
                  "",
                  "    (async () => {",
                  "        const caseRes = await send({ url: `${baseUrl}/api/v1/Case/${caseId}` });",
                  "        pm.expect(caseRes.code, 'case lookup status').to.eql(200);",
                  "        const caseValue = caseRes.json().value || {};",
                  "        const patient = caseValue.patient || {};",
                  "        const patientId = patient.id;",
                  "        pm.collectionVariables.set('autoTaskPatientId', patientId);",
                  "        pm.expect(patientId, 'patient id from case lookup').to.exist;",
                  "",
                  "        const patchBody = [",
                  "            { op: 'replace', path: '/driversLicenseState', value: 'AK' },",
                  "            { op: 'replace', path: '/driversLicenseNumber', value: '33' },",
                  "            { op: 'replace', path: '/driversLicenseExpirationDate', value: '2028-11-02T00:00:00Z' }",
                  "        ];",
                  "        const patchRes = await send({",
                  "            url: `${baseUrl}/api/v1/Patients/json-patch/${patientId}`,",
                  "            method: 'PATCH',",
                  "            headers: { 'Content-Type': 'application/json-patch+json' },",
                  "            body: JSON.stringify(patchBody)",
                  "        });",
                  "        pm.expect(patchRes.code, 'patient patch status').to.be.oneOf([200, 204]);",
                  "",
                  "        const insuranceStateRes = await send({",
                  "            url: `${baseUrl}/api/v1/CaseInsurance/apply-insurance-state-changes`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                caseId: Number(caseId),",
                  "                patientHasInsurance: true",
                  "            }",
                  "        });",
                  "        pm.expect(insuranceStateRes.code, 'apply insurance state status').to.be.oneOf([200, 204]);",
                  "",
                  "        if (!scenarioConfig.expectation || scenarioConfig.expectation.skipPharmacyPlan !== true) {",
                  "            const planPayload = {",
                  "                planId: 18,",
                  "                caseId: Number(caseId),",
                  "                plan: {",
                  "                    id: 18,",
                  "                    isPBM: false,",
                  "                    name: 'Automation Insurance Plan',",
                  "                    address: {",
                  "                        streetAddress: null,",
                  "                        addressExtension: '',",
                  "                        zipCode: '81110',",
                  "                        city: 'Zymna',",
                  "                        state: 'KY',",
                  "                        countryId: null,",
                  "                        countryName: null",
                  "                    },",
                  "                    phone: '9787564444',",
                  "                    fax: '9787656453',",
                  "                    faxCountryIso2: null,",
                  "                    active: true,",
                  "                    specialtyPharmacyId: -9999,",
                  "                    specialtyPharmacyName: null,",
                  "                    externalSourcePharmacyBenefitPlanId: null,",
                  "                    typeId: 1,",
                  "                    typeName: 'Commercial',",
                  "                    subTypeId: 2,",
                  "                    subTypeName: 'Private/Commercial'",
                  "                },",
                  "                isAddNewInsurance: true,",
                  "                insurance: {",
                  "                    insurancePriorityId: 1,",
                  "                    coverageTypeId: 2,",
                  "                    effectiveFrom: '2025-11-02T00:00:00Z',",
                  "                    effectiveTo: '2028-11-02T00:00:00Z',",
                  "                    groupNumber: '443',",
                  "                    employerName: 'Employer John',",
                  "                    memberId: '555',",
                  "                    planNumber: '444',",
                  "                    patientId: patientId,",
                  "                    policyHolderName: `${patientFirstName} ${patientLastName}`.trim(),",
                  "                    bin: '888',",
                  "                    pcn: '999'",
                  "                }",
                  "            };",
                  "            const planRes = await send({",
                  "                url: `${baseUrl}/api/v1/PatientInsurance/updatePharmacyPlan`,",
                  "                method: 'PATCH',",
                  "                headers: { 'Content-Type': 'application/json' },",
                  "                body: planPayload",
                  "            });",
                  "            pm.expect(planRes.code, 'update pharmacy plan status').to.be.oneOf([200, 204]);",
                  "        }",
                  "",
                  "        const consentRes = await send({",
                  "            url: `${baseUrl}/api/v1/Consents`,",
                  "            method: 'PUT',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                consent: {",
                  "                    id: 0,",
                  "                    consentTypeId: 1,",
                  "                    consentIsOnFile: true,",
                  "                    consentMethod: 1,",
                  "                    dateReceived: '2025-11-02T00:00:00.000Z',",
                  "                    effectiveEndDate: '2028-12-02T00:00:00.000Z',",
                  "                    patientId: patientId",
                  "                }",
                  "            }",
                  "        });",
                  "        pm.expect(consentRes.code, 'consent status').to.be.oneOf([200, 204]);",
                  "",
                  "        const tasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(tasksRes.code, 'initial tasks status').to.eql(200);",
                  "        const tasksJson = tasksRes.json();",
                  "        const tasks = Array.isArray(tasksJson.value) ? tasksJson.value : [];",
                  "        const followUps = tasks.filter(task => ((task.taskName || '').trim() === 'Follow-up with Patient re: Missing Information'));",
                  "        pm.expect(followUps.length, 'available manual follow-up tasks').to.be.greaterThan(0);",
                  "        const latestFollowUp = followUps.reduce((latest, current) => (!latest || current.id > latest.id) ? current : latest, null);",
                  "        const queueItemId = latestFollowUp && latestFollowUp.id;",
                  "        pm.expect(queueItemId, 'queue item id for manual follow-up').to.exist;",
                  "",
                  "        const defaultAnswers = [",
                  "            { id: 812, answer: 'true', metadata: null, note: null, question: { id: 9001 }, chosenOptions: [] },",
                  "            { id: 813, answer: '[]', metadata: null, note: null, question: { id: 9002 }, chosenOptions: [] },",
                  "            { id: 814, answer: '', metadata: null, note: null, question: { id: 9003 }, chosenOptions: [] },",
                  "            { id: 815, answer: '', metadata: null, note: null, question: { id: 9004, options: [] }, chosenOptions: [] },",
                  "            { id: 816, answer: '', metadata: null, note: null, question: { id: 9005 }, chosenOptions: [] },",
                  "            { id: 817, answer: '', metadata: null, note: null, question: { id: 9006 }, chosenOptions: [] }",
                  "        ];",
                  "",
                  "        await send({",
                  "            url: `${baseUrl}/api/v1/workflow/complete-task`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                queueItemId: queueItemId,",
                  "                outcomeNotes: null,",
                  "                contactValue: '0000000000',",
                  "                coversheetNotes: null,",
                  "                answers: scenarioConfig.answers || defaultAnswers,",
                  "                attachments: [],",
                  "                markAsFailed: false,",
                  "                includeAllAttachments: false",
                  "            }",
                  "        });",
                  "",
                  "        const refreshedTasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(refreshedTasksRes.code, 'refreshed tasks status').to.eql(200);",
                  "        const refreshedTasksJson = refreshedTasksRes.json();",
                  "        const refreshedTasks = Array.isArray(refreshedTasksJson.value) ? refreshedTasksJson.value : [];",
                  "        const eBenefitTask = refreshedTasks.find(task => ((task.taskName || '').trim() === 'e-Benefit Verification'));",
                  "        pm.expect(eBenefitTask, 'auto task e-benefit verification created').to.exist;",
                  "        const eBenefitId = eBenefitTask && eBenefitTask.id;",
                  "        pm.collectionVariables.set('autoTaskLastTaskId', eBenefitId);",
                  "",
                  "        const eBenefitRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/${eBenefitId}` });",
                  "        pm.expect(eBenefitRes.code, 'e-benefit task lookup status').to.eql(200);",
                  "        const eBenefitJson = eBenefitRes.json();",
                  "        const taskValue = eBenefitJson.value || {};",
                  "        pm.collectionVariables.set('autoTaskLastTaskResponse', JSON.stringify(taskValue));",
                  "",
                  "        const histories = Array.isArray(taskValue.externalApiRequestHistories) ? taskValue.externalApiRequestHistories : [];",
                  "        pm.expect(histories.length, 'external API request history entries').to.be.greaterThan(0);",
                  "",
                  "        const historyWithResponses = histories.filter(history => Array.isArray(history.responseHistory) && history.responseHistory.length);",
                  "        pm.expect(historyWithResponses.length, 'history entries with responses').to.be.greaterThan(0);",
                  "        const lastHistory = historyWithResponses[historyWithResponses.length - 1];",
                  "        const lastResponse = lastHistory.responseHistory[lastHistory.responseHistory.length - 1] || {};",
                  "        const responseText = lastResponse.response || '';",
                  "        let parsedResponse;",
                  "        try {",
                  "            parsedResponse = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;",
                  "        } catch (err) {",
                  "            parsedResponse = null;",
                  "        }",
                  "        const body = parsedResponse && parsedResponse.Body ? parsedResponse.Body : (parsedResponse || {});",
                  "        const coveragesSource = body.coverages || body.Coverages || body.coverage || body.Coverage || [];",
                  "        const coverages = Array.isArray(coveragesSource) ? coveragesSource : [];",
                  "        const normalizedCoverages = coverages.map(item => ({",
                  "            type: (item.coverageType || item.CoverageType || '').toString().toLowerCase(),",
                  "            insurance: (item.insurance || item.Insurance || '').toString().toLowerCase()",
                  "        }));",
                  "",
                  "        if (scenarioConfig.expectation && scenarioConfig.expectation.expectFailure) {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.eql('failed');",
                  "            pm.expect(coverages.length, 'coverages count for failed scenario').to.eql(0);",
                  "        } else {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.not.eql('failed');",
                  "            if (typeof scenarioConfig.expectation.expectedCoverageCount === 'number') {",
                  "                pm.expect(coverages.length, 'coverage count').to.eql(scenarioConfig.expectation.expectedCoverageCount);",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedCoverageTypes)) {",
                  "                scenarioConfig.expectation.expectedCoverageTypes.forEach(expectedType => {",
                  "                    const match = normalizedCoverages.some(item => item.type === expectedType.toLowerCase());",
                  "                    pm.expect(match, `coverage type ${expectedType} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedInsuranceNames) && scenarioConfig.expectation.expectedInsuranceNames.length) {",
                  "                scenarioConfig.expectation.expectedInsuranceNames.forEach(expectedName => {",
                  "                    const match = normalizedCoverages.some(item => item.insurance === expectedName.toLowerCase());",
                  "                    pm.expect(match, `insurance ${expectedName} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "        }",
                  "",
                  "        done();",
                  "    })().catch(error => {",
                  "        console.error('Auto task scenario execution failed', error);",
                  "        pm.expect.fail(error && error.message ? error.message : error);",
                  "        done();",
                  "    });",
                  "});",
                  ""
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "{{apiKey}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{autoTaskPrescriptionNumber}}\",\n    \"ndc\": \"{{autoTaskNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"10 mg\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{autoTaskPatientExternalId}},\n    \"firstName\": \"{{autoTaskPatientFirstName}}\",\n    \"lastName\": \"{{autoTaskPatientLastName}}\",\n    \"dateOfBirth\": \"1988-02-01T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{autoTaskPatientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\",\n        \"addressExtension\": \"Suite {{autoTaskSuffix}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{autoTaskPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{autoTaskPhysicianNpi}}\",\n    \"firstName\": \"Auto\",\n    \"lastName\": \"Prescriber{{autoTaskSuffix}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\"\n      }\n    ]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "caremetx",
                "prescription-integration"
              ]
            }
          },
          "response": []
        },
        {
          "name": "Medicare Coverage",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const expectation = {",
                  "        \"expectedCoverageCount\": 1,",
                  "        \"expectedCoverageTypes\": [",
                  "            \"primary\"",
                  "        ],",
                  "        \"expectedInsuranceNames\": [",
                  "            \"medicare\"",
                  "        ],",
                  "        \"expectFailure\": false",
                  "    };",
                  "const scenarioConfig = {",
                  "    key: 'medicare',",
                  "    firstName: 'Mary',",
                  "    expectation",
                  "};",
                  "",
                  "const timestamp = Date.now();",
                  "const suffix = timestamp.toString().slice(-5);",
                  "const randomId = Math.floor(Math.random() * 9000000) + 1000000;",
                  "const patientLastName = `Eligibility${suffix}`;",
                  "const patientEmail = `auto-task-${scenarioConfig.key}-${suffix}@example.com`;",
                  "const patientPhone = `502${(Math.floor(Math.random() * 9000000) + 1000000).toString().padStart(7, '0')}`;",
                  "const physicianNpi = `${Math.floor(Math.random() * 9000000000) + 1000000000}`;",
                  "const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Eligibility Way`;",
                  "const facilityZip = `${Math.floor(Math.random() * 90000) + 10000}`;",
                  "",
                  "pm.collectionVariables.set('autoTaskScenarioConfig', JSON.stringify(scenarioConfig));",
                  "pm.collectionVariables.set('autoTaskScenarioKey', scenarioConfig.key);",
                  "pm.collectionVariables.set('autoTaskSeedTimestamp', String(timestamp));",
                  "pm.collectionVariables.set('autoTaskSuffix', suffix);",
                  "",
                  "pm.collectionVariables.set('autoTaskPatientExternalId', String(randomId));",
                  "pm.collectionVariables.set('autoTaskPatientFirstName', scenarioConfig.firstName);",
                  "pm.collectionVariables.set('autoTaskPatientLastName', patientLastName);",
                  "pm.collectionVariables.set('autoTaskPatientEmail', patientEmail);",
                  "pm.collectionVariables.set('autoTaskPatientPhone', patientPhone);",
                  "pm.collectionVariables.set('autoTaskPhysicianNpi', physicianNpi);",
                  "pm.collectionVariables.set('autoTaskPrescriptionNumber', `RX-AUTO-${timestamp}`);",
                  "pm.collectionVariables.set('autoTaskNdc', `${Math.floor(Math.random() * 90000000000) + 10000000000}`);",
                  "pm.collectionVariables.set('autoTaskFacilityAddress1', facilityAddress1);",
                  "pm.collectionVariables.set('autoTaskFacilityCity', 'Louisville');",
                  "pm.collectionVariables.set('autoTaskFacilityState', 'KY');",
                  "pm.collectionVariables.set('autoTaskFacilityStateId', '21');",
                  "pm.collectionVariables.set('autoTaskFacilityZip', facilityZip);",
                  ""
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const scenarioConfigRaw = pm.collectionVariables.get('autoTaskScenarioConfig');",
                  "let scenarioConfig = {};",
                  "try {",
                  "    scenarioConfig = scenarioConfigRaw ? JSON.parse(scenarioConfigRaw) : {};",
                  "} catch (err) {",
                  "    console.error('Failed to parse scenario config', err);",
                  "    scenarioConfig = {};",
                  "}",
                  "const scenarioKey = scenarioConfig.key || 'unknown';",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - prescription intake accepted`, function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('value');",
                  "    pm.expect(json.value).to.have.property('caseId');",
                  "    pm.expect(json.success).to.eql(true);",
                  "});",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - completes verification flow`, function (done) {",
                  "    const responseJson = pm.response.json();",
                  "    const caseId = responseJson.value && responseJson.value.caseId;",
                  "    pm.collectionVariables.set('autoTaskCaseId', caseId);",
                  "    const baseUrl = pm.variables.replaceIn('{{base_url}}');",
                  "    const authToken = pm.variables.replaceIn('{{apiKey}}');",
                  "    if (!caseId) {",
                  "        pm.expect.fail('Case identifier missing from prescription intake response.');",
                  "        return done();",
                  "    }",
                  "    if (!baseUrl || !authToken) {",
                  "        pm.expect.fail('Environment variables base_url or apiKey are not configured.');",
                  "        return done();",
                  "    }",
                  "    const patientFirstName = pm.collectionVariables.get('autoTaskPatientFirstName');",
                  "    const patientLastName = pm.collectionVariables.get('autoTaskPatientLastName');",
                  "",
                  "    const toHeaderArray = (extraHeaders = {}) => {",
                  "        const headers = [",
                  "            { key: 'Authorization', value: authToken }",
                  "        ];",
                  "        Object.keys(extraHeaders).forEach(key => {",
                  "            headers.push({ key, value: extraHeaders[key] });",
                  "        });",
                  "        return headers;",
                  "    };",
                  "",
                  "    const send = (options) => new Promise((resolve, reject) => {",
                  "        const requestOptions = {",
                  "            url: options.url,",
                  "            method: options.method || 'GET',",
                  "            header: toHeaderArray(options.headers || {})",
                  "        };",
                  "        if (options.body !== undefined) {",
                  "            const rawBody = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);",
                  "            requestOptions.body = { mode: 'raw', raw: rawBody };",
                  "        }",
                  "        pm.sendRequest(requestOptions, (err, res) => {",
                  "            if (err) {",
                  "                reject(err);",
                  "                return;",
                  "            }",
                  "            if (!res) {",
                  "                reject(new Error('No response object returned.'));",
                  "                return;",
                  "            }",
                  "            resolve(res);",
                  "        });",
                  "    });",
                  "",
                  "    (async () => {",
                  "        const caseRes = await send({ url: `${baseUrl}/api/v1/Case/${caseId}` });",
                  "        pm.expect(caseRes.code, 'case lookup status').to.eql(200);",
                  "        const caseValue = caseRes.json().value || {};",
                  "        const patient = caseValue.patient || {};",
                  "        const patientId = patient.id;",
                  "        pm.collectionVariables.set('autoTaskPatientId', patientId);",
                  "        pm.expect(patientId, 'patient id from case lookup').to.exist;",
                  "",
                  "        const patchBody = [",
                  "            { op: 'replace', path: '/driversLicenseState', value: 'AK' },",
                  "            { op: 'replace', path: '/driversLicenseNumber', value: '33' },",
                  "            { op: 'replace', path: '/driversLicenseExpirationDate', value: '2028-11-02T00:00:00Z' }",
                  "        ];",
                  "        const patchRes = await send({",
                  "            url: `${baseUrl}/api/v1/Patients/json-patch/${patientId}`,",
                  "            method: 'PATCH',",
                  "            headers: { 'Content-Type': 'application/json-patch+json' },",
                  "            body: JSON.stringify(patchBody)",
                  "        });",
                  "        pm.expect(patchRes.code, 'patient patch status').to.be.oneOf([200, 204]);",
                  "",
                  "        const insuranceStateRes = await send({",
                  "            url: `${baseUrl}/api/v1/CaseInsurance/apply-insurance-state-changes`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                caseId: Number(caseId),",
                  "                patientHasInsurance: true",
                  "            }",
                  "        });",
                  "        pm.expect(insuranceStateRes.code, 'apply insurance state status').to.be.oneOf([200, 204]);",
                  "",
                  "        if (!scenarioConfig.expectation || scenarioConfig.expectation.skipPharmacyPlan !== true) {",
                  "            const planPayload = {",
                  "                planId: 18,",
                  "                caseId: Number(caseId),",
                  "                plan: {",
                  "                    id: 18,",
                  "                    isPBM: false,",
                  "                    name: 'Automation Insurance Plan',",
                  "                    address: {",
                  "                        streetAddress: null,",
                  "                        addressExtension: '',",
                  "                        zipCode: '81110',",
                  "                        city: 'Zymna',",
                  "                        state: 'KY',",
                  "                        countryId: null,",
                  "                        countryName: null",
                  "                    },",
                  "                    phone: '9787564444',",
                  "                    fax: '9787656453',",
                  "                    faxCountryIso2: null,",
                  "                    active: true,",
                  "                    specialtyPharmacyId: -9999,",
                  "                    specialtyPharmacyName: null,",
                  "                    externalSourcePharmacyBenefitPlanId: null,",
                  "                    typeId: 1,",
                  "                    typeName: 'Commercial',",
                  "                    subTypeId: 2,",
                  "                    subTypeName: 'Private/Commercial'",
                  "                },",
                  "                isAddNewInsurance: true,",
                  "                insurance: {",
                  "                    insurancePriorityId: 1,",
                  "                    coverageTypeId: 2,",
                  "                    effectiveFrom: '2025-11-02T00:00:00Z',",
                  "                    effectiveTo: '2028-11-02T00:00:00Z',",
                  "                    groupNumber: '443',",
                  "                    employerName: 'Employer John',",
                  "                    memberId: '555',",
                  "                    planNumber: '444',",
                  "                    patientId: patientId,",
                  "                    policyHolderName: `${patientFirstName} ${patientLastName}`.trim(),",
                  "                    bin: '888',",
                  "                    pcn: '999'",
                  "                }",
                  "            };",
                  "            const planRes = await send({",
                  "                url: `${baseUrl}/api/v1/PatientInsurance/updatePharmacyPlan`,",
                  "                method: 'PATCH',",
                  "                headers: { 'Content-Type': 'application/json' },",
                  "                body: planPayload",
                  "            });",
                  "            pm.expect(planRes.code, 'update pharmacy plan status').to.be.oneOf([200, 204]);",
                  "        }",
                  "",
                  "        const consentRes = await send({",
                  "            url: `${baseUrl}/api/v1/Consents`,",
                  "            method: 'PUT',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                consent: {",
                  "                    id: 0,",
                  "                    consentTypeId: 1,",
                  "                    consentIsOnFile: true,",
                  "                    consentMethod: 1,",
                  "                    dateReceived: '2025-11-02T00:00:00.000Z',",
                  "                    effectiveEndDate: '2028-12-02T00:00:00.000Z',",
                  "                    patientId: patientId",
                  "                }",
                  "            }",
                  "        });",
                  "        pm.expect(consentRes.code, 'consent status').to.be.oneOf([200, 204]);",
                  "",
                  "        const tasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(tasksRes.code, 'initial tasks status').to.eql(200);",
                  "        const tasksJson = tasksRes.json();",
                  "        const tasks = Array.isArray(tasksJson.value) ? tasksJson.value : [];",
                  "        const followUps = tasks.filter(task => ((task.taskName || '').trim() === 'Follow-up with Patient re: Missing Information'));",
                  "        pm.expect(followUps.length, 'available manual follow-up tasks').to.be.greaterThan(0);",
                  "        const latestFollowUp = followUps.reduce((latest, current) => (!latest || current.id > latest.id) ? current : latest, null);",
                  "        const queueItemId = latestFollowUp && latestFollowUp.id;",
                  "        pm.expect(queueItemId, 'queue item id for manual follow-up').to.exist;",
                  "",
                  "        const defaultAnswers = [",
                  "            { id: 812, answer: 'true', metadata: null, note: null, question: { id: 9001 }, chosenOptions: [] },",
                  "            { id: 813, answer: '[]', metadata: null, note: null, question: { id: 9002 }, chosenOptions: [] },",
                  "            { id: 814, answer: '', metadata: null, note: null, question: { id: 9003 }, chosenOptions: [] },",
                  "            { id: 815, answer: '', metadata: null, note: null, question: { id: 9004, options: [] }, chosenOptions: [] },",
                  "            { id: 816, answer: '', metadata: null, note: null, question: { id: 9005 }, chosenOptions: [] },",
                  "            { id: 817, answer: '', metadata: null, note: null, question: { id: 9006 }, chosenOptions: [] }",
                  "        ];",
                  "",
                  "        await send({",
                  "            url: `${baseUrl}/api/v1/workflow/complete-task`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                queueItemId: queueItemId,",
                  "                outcomeNotes: null,",
                  "                contactValue: '0000000000',",
                  "                coversheetNotes: null,",
                  "                answers: scenarioConfig.answers || defaultAnswers,",
                  "                attachments: [],",
                  "                markAsFailed: false,",
                  "                includeAllAttachments: false",
                  "            }",
                  "        });",
                  "",
                  "        const refreshedTasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(refreshedTasksRes.code, 'refreshed tasks status').to.eql(200);",
                  "        const refreshedTasksJson = refreshedTasksRes.json();",
                  "        const refreshedTasks = Array.isArray(refreshedTasksJson.value) ? refreshedTasksJson.value : [];",
                  "        const eBenefitTask = refreshedTasks.find(task => ((task.taskName || '').trim() === 'e-Benefit Verification'));",
                  "        pm.expect(eBenefitTask, 'auto task e-benefit verification created').to.exist;",
                  "        const eBenefitId = eBenefitTask && eBenefitTask.id;",
                  "        pm.collectionVariables.set('autoTaskLastTaskId', eBenefitId);",
                  "",
                  "        const eBenefitRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/${eBenefitId}` });",
                  "        pm.expect(eBenefitRes.code, 'e-benefit task lookup status').to.eql(200);",
                  "        const eBenefitJson = eBenefitRes.json();",
                  "        const taskValue = eBenefitJson.value || {};",
                  "        pm.collectionVariables.set('autoTaskLastTaskResponse', JSON.stringify(taskValue));",
                  "",
                  "        const histories = Array.isArray(taskValue.externalApiRequestHistories) ? taskValue.externalApiRequestHistories : [];",
                  "        pm.expect(histories.length, 'external API request history entries').to.be.greaterThan(0);",
                  "",
                  "        const historyWithResponses = histories.filter(history => Array.isArray(history.responseHistory) && history.responseHistory.length);",
                  "        pm.expect(historyWithResponses.length, 'history entries with responses').to.be.greaterThan(0);",
                  "        const lastHistory = historyWithResponses[historyWithResponses.length - 1];",
                  "        const lastResponse = lastHistory.responseHistory[lastHistory.responseHistory.length - 1] || {};",
                  "        const responseText = lastResponse.response || '';",
                  "        let parsedResponse;",
                  "        try {",
                  "            parsedResponse = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;",
                  "        } catch (err) {",
                  "            parsedResponse = null;",
                  "        }",
                  "        const body = parsedResponse && parsedResponse.Body ? parsedResponse.Body : (parsedResponse || {});",
                  "        const coveragesSource = body.coverages || body.Coverages || body.coverage || body.Coverage || [];",
                  "        const coverages = Array.isArray(coveragesSource) ? coveragesSource : [];",
                  "        const normalizedCoverages = coverages.map(item => ({",
                  "            type: (item.coverageType || item.CoverageType || '').toString().toLowerCase(),",
                  "            insurance: (item.insurance || item.Insurance || '').toString().toLowerCase()",
                  "        }));",
                  "",
                  "        if (scenarioConfig.expectation && scenarioConfig.expectation.expectFailure) {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.eql('failed');",
                  "            pm.expect(coverages.length, 'coverages count for failed scenario').to.eql(0);",
                  "        } else {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.not.eql('failed');",
                  "            if (typeof scenarioConfig.expectation.expectedCoverageCount === 'number') {",
                  "                pm.expect(coverages.length, 'coverage count').to.eql(scenarioConfig.expectation.expectedCoverageCount);",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedCoverageTypes)) {",
                  "                scenarioConfig.expectation.expectedCoverageTypes.forEach(expectedType => {",
                  "                    const match = normalizedCoverages.some(item => item.type === expectedType.toLowerCase());",
                  "                    pm.expect(match, `coverage type ${expectedType} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedInsuranceNames) && scenarioConfig.expectation.expectedInsuranceNames.length) {",
                  "                scenarioConfig.expectation.expectedInsuranceNames.forEach(expectedName => {",
                  "                    const match = normalizedCoverages.some(item => item.insurance === expectedName.toLowerCase());",
                  "                    pm.expect(match, `insurance ${expectedName} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "        }",
                  "",
                  "        done();",
                  "    })().catch(error => {",
                  "        console.error('Auto task scenario execution failed', error);",
                  "        pm.expect.fail(error && error.message ? error.message : error);",
                  "        done();",
                  "    });",
                  "});",
                  ""
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "{{apiKey}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{autoTaskPrescriptionNumber}}\",\n    \"ndc\": \"{{autoTaskNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"10 mg\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{autoTaskPatientExternalId}},\n    \"firstName\": \"{{autoTaskPatientFirstName}}\",\n    \"lastName\": \"{{autoTaskPatientLastName}}\",\n    \"dateOfBirth\": \"1988-02-01T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{autoTaskPatientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\",\n        \"addressExtension\": \"Suite {{autoTaskSuffix}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{autoTaskPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{autoTaskPhysicianNpi}}\",\n    \"firstName\": \"Auto\",\n    \"lastName\": \"Prescriber{{autoTaskSuffix}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\"\n      }\n    ]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "caremetx",
                "prescription-integration"
              ]
            }
          },
          "response": []
        },
        {
          "name": "No Coverage Returned",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const expectation = {",
                  "        \"expectedCoverageCount\": 0,",
                  "        \"expectedCoverageTypes\": [],",
                  "        \"expectedInsuranceNames\": [],",
                  "        \"expectFailure\": false",
                  "    };",
                  "const scenarioConfig = {",
                  "    key: 'noCoverage',",
                  "    firstName: 'None',",
                  "    expectation",
                  "};",
                  "",
                  "const timestamp = Date.now();",
                  "const suffix = timestamp.toString().slice(-5);",
                  "const randomId = Math.floor(Math.random() * 9000000) + 1000000;",
                  "const patientLastName = `Eligibility${suffix}`;",
                  "const patientEmail = `auto-task-${scenarioConfig.key}-${suffix}@example.com`;",
                  "const patientPhone = `502${(Math.floor(Math.random() * 9000000) + 1000000).toString().padStart(7, '0')}`;",
                  "const physicianNpi = `${Math.floor(Math.random() * 9000000000) + 1000000000}`;",
                  "const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Eligibility Way`;",
                  "const facilityZip = `${Math.floor(Math.random() * 90000) + 10000}`;",
                  "",
                  "pm.collectionVariables.set('autoTaskScenarioConfig', JSON.stringify(scenarioConfig));",
                  "pm.collectionVariables.set('autoTaskScenarioKey', scenarioConfig.key);",
                  "pm.collectionVariables.set('autoTaskSeedTimestamp', String(timestamp));",
                  "pm.collectionVariables.set('autoTaskSuffix', suffix);",
                  "",
                  "pm.collectionVariables.set('autoTaskPatientExternalId', String(randomId));",
                  "pm.collectionVariables.set('autoTaskPatientFirstName', scenarioConfig.firstName);",
                  "pm.collectionVariables.set('autoTaskPatientLastName', patientLastName);",
                  "pm.collectionVariables.set('autoTaskPatientEmail', patientEmail);",
                  "pm.collectionVariables.set('autoTaskPatientPhone', patientPhone);",
                  "pm.collectionVariables.set('autoTaskPhysicianNpi', physicianNpi);",
                  "pm.collectionVariables.set('autoTaskPrescriptionNumber', `RX-AUTO-${timestamp}`);",
                  "pm.collectionVariables.set('autoTaskNdc', `${Math.floor(Math.random() * 90000000000) + 10000000000}`);",
                  "pm.collectionVariables.set('autoTaskFacilityAddress1', facilityAddress1);",
                  "pm.collectionVariables.set('autoTaskFacilityCity', 'Louisville');",
                  "pm.collectionVariables.set('autoTaskFacilityState', 'KY');",
                  "pm.collectionVariables.set('autoTaskFacilityStateId', '21');",
                  "pm.collectionVariables.set('autoTaskFacilityZip', facilityZip);",
                  ""
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const scenarioConfigRaw = pm.collectionVariables.get('autoTaskScenarioConfig');",
                  "let scenarioConfig = {};",
                  "try {",
                  "    scenarioConfig = scenarioConfigRaw ? JSON.parse(scenarioConfigRaw) : {};",
                  "} catch (err) {",
                  "    console.error('Failed to parse scenario config', err);",
                  "    scenarioConfig = {};",
                  "}",
                  "const scenarioKey = scenarioConfig.key || 'unknown';",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - prescription intake accepted`, function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('value');",
                  "    pm.expect(json.value).to.have.property('caseId');",
                  "    pm.expect(json.success).to.eql(true);",
                  "});",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - completes verification flow`, function (done) {",
                  "    const responseJson = pm.response.json();",
                  "    const caseId = responseJson.value && responseJson.value.caseId;",
                  "    pm.collectionVariables.set('autoTaskCaseId', caseId);",
                  "    const baseUrl = pm.variables.replaceIn('{{base_url}}');",
                  "    const authToken = pm.variables.replaceIn('{{apiKey}}');",
                  "    if (!caseId) {",
                  "        pm.expect.fail('Case identifier missing from prescription intake response.');",
                  "        return done();",
                  "    }",
                  "    if (!baseUrl || !authToken) {",
                  "        pm.expect.fail('Environment variables base_url or apiKey are not configured.');",
                  "        return done();",
                  "    }",
                  "    const patientFirstName = pm.collectionVariables.get('autoTaskPatientFirstName');",
                  "    const patientLastName = pm.collectionVariables.get('autoTaskPatientLastName');",
                  "",
                  "    const toHeaderArray = (extraHeaders = {}) => {",
                  "        const headers = [",
                  "            { key: 'Authorization', value: authToken }",
                  "        ];",
                  "        Object.keys(extraHeaders).forEach(key => {",
                  "            headers.push({ key, value: extraHeaders[key] });",
                  "        });",
                  "        return headers;",
                  "    };",
                  "",
                  "    const send = (options) => new Promise((resolve, reject) => {",
                  "        const requestOptions = {",
                  "            url: options.url,",
                  "            method: options.method || 'GET',",
                  "            header: toHeaderArray(options.headers || {})",
                  "        };",
                  "        if (options.body !== undefined) {",
                  "            const rawBody = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);",
                  "            requestOptions.body = { mode: 'raw', raw: rawBody };",
                  "        }",
                  "        pm.sendRequest(requestOptions, (err, res) => {",
                  "            if (err) {",
                  "                reject(err);",
                  "                return;",
                  "            }",
                  "            if (!res) {",
                  "                reject(new Error('No response object returned.'));",
                  "                return;",
                  "            }",
                  "            resolve(res);",
                  "        });",
                  "    });",
                  "",
                  "    (async () => {",
                  "        const caseRes = await send({ url: `${baseUrl}/api/v1/Case/${caseId}` });",
                  "        pm.expect(caseRes.code, 'case lookup status').to.eql(200);",
                  "        const caseValue = caseRes.json().value || {};",
                  "        const patient = caseValue.patient || {};",
                  "        const patientId = patient.id;",
                  "        pm.collectionVariables.set('autoTaskPatientId', patientId);",
                  "        pm.expect(patientId, 'patient id from case lookup').to.exist;",
                  "",
                  "        const patchBody = [",
                  "            { op: 'replace', path: '/driversLicenseState', value: 'AK' },",
                  "            { op: 'replace', path: '/driversLicenseNumber', value: '33' },",
                  "            { op: 'replace', path: '/driversLicenseExpirationDate', value: '2028-11-02T00:00:00Z' }",
                  "        ];",
                  "        const patchRes = await send({",
                  "            url: `${baseUrl}/api/v1/Patients/json-patch/${patientId}`,",
                  "            method: 'PATCH',",
                  "            headers: { 'Content-Type': 'application/json-patch+json' },",
                  "            body: JSON.stringify(patchBody)",
                  "        });",
                  "        pm.expect(patchRes.code, 'patient patch status').to.be.oneOf([200, 204]);",
                  "",
                  "        const insuranceStateRes = await send({",
                  "            url: `${baseUrl}/api/v1/CaseInsurance/apply-insurance-state-changes`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                caseId: Number(caseId),",
                  "                patientHasInsurance: true",
                  "            }",
                  "        });",
                  "        pm.expect(insuranceStateRes.code, 'apply insurance state status').to.be.oneOf([200, 204]);",
                  "",
                  "        if (!scenarioConfig.expectation || scenarioConfig.expectation.skipPharmacyPlan !== true) {",
                  "            const planPayload = {",
                  "                planId: 18,",
                  "                caseId: Number(caseId),",
                  "                plan: {",
                  "                    id: 18,",
                  "                    isPBM: false,",
                  "                    name: 'Automation Insurance Plan',",
                  "                    address: {",
                  "                        streetAddress: null,",
                  "                        addressExtension: '',",
                  "                        zipCode: '81110',",
                  "                        city: 'Zymna',",
                  "                        state: 'KY',",
                  "                        countryId: null,",
                  "                        countryName: null",
                  "                    },",
                  "                    phone: '9787564444',",
                  "                    fax: '9787656453',",
                  "                    faxCountryIso2: null,",
                  "                    active: true,",
                  "                    specialtyPharmacyId: -9999,",
                  "                    specialtyPharmacyName: null,",
                  "                    externalSourcePharmacyBenefitPlanId: null,",
                  "                    typeId: 1,",
                  "                    typeName: 'Commercial',",
                  "                    subTypeId: 2,",
                  "                    subTypeName: 'Private/Commercial'",
                  "                },",
                  "                isAddNewInsurance: true,",
                  "                insurance: {",
                  "                    insurancePriorityId: 1,",
                  "                    coverageTypeId: 2,",
                  "                    effectiveFrom: '2025-11-02T00:00:00Z',",
                  "                    effectiveTo: '2028-11-02T00:00:00Z',",
                  "                    groupNumber: '443',",
                  "                    employerName: 'Employer John',",
                  "                    memberId: '555',",
                  "                    planNumber: '444',",
                  "                    patientId: patientId,",
                  "                    policyHolderName: `${patientFirstName} ${patientLastName}`.trim(),",
                  "                    bin: '888',",
                  "                    pcn: '999'",
                  "                }",
                  "            };",
                  "            const planRes = await send({",
                  "                url: `${baseUrl}/api/v1/PatientInsurance/updatePharmacyPlan`,",
                  "                method: 'PATCH',",
                  "                headers: { 'Content-Type': 'application/json' },",
                  "                body: planPayload",
                  "            });",
                  "            pm.expect(planRes.code, 'update pharmacy plan status').to.be.oneOf([200, 204]);",
                  "        }",
                  "",
                  "        const consentRes = await send({",
                  "            url: `${baseUrl}/api/v1/Consents`,",
                  "            method: 'PUT',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                consent: {",
                  "                    id: 0,",
                  "                    consentTypeId: 1,",
                  "                    consentIsOnFile: true,",
                  "                    consentMethod: 1,",
                  "                    dateReceived: '2025-11-02T00:00:00.000Z',",
                  "                    effectiveEndDate: '2028-12-02T00:00:00.000Z',",
                  "                    patientId: patientId",
                  "                }",
                  "            }",
                  "        });",
                  "        pm.expect(consentRes.code, 'consent status').to.be.oneOf([200, 204]);",
                  "",
                  "        const tasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(tasksRes.code, 'initial tasks status').to.eql(200);",
                  "        const tasksJson = tasksRes.json();",
                  "        const tasks = Array.isArray(tasksJson.value) ? tasksJson.value : [];",
                  "        const followUps = tasks.filter(task => ((task.taskName || '').trim() === 'Follow-up with Patient re: Missing Information'));",
                  "        pm.expect(followUps.length, 'available manual follow-up tasks').to.be.greaterThan(0);",
                  "        const latestFollowUp = followUps.reduce((latest, current) => (!latest || current.id > latest.id) ? current : latest, null);",
                  "        const queueItemId = latestFollowUp && latestFollowUp.id;",
                  "        pm.expect(queueItemId, 'queue item id for manual follow-up').to.exist;",
                  "",
                  "        const defaultAnswers = [",
                  "            { id: 812, answer: 'true', metadata: null, note: null, question: { id: 9001 }, chosenOptions: [] },",
                  "            { id: 813, answer: '[]', metadata: null, note: null, question: { id: 9002 }, chosenOptions: [] },",
                  "            { id: 814, answer: '', metadata: null, note: null, question: { id: 9003 }, chosenOptions: [] },",
                  "            { id: 815, answer: '', metadata: null, note: null, question: { id: 9004, options: [] }, chosenOptions: [] },",
                  "            { id: 816, answer: '', metadata: null, note: null, question: { id: 9005 }, chosenOptions: [] },",
                  "            { id: 817, answer: '', metadata: null, note: null, question: { id: 9006 }, chosenOptions: [] }",
                  "        ];",
                  "",
                  "        await send({",
                  "            url: `${baseUrl}/api/v1/workflow/complete-task`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                queueItemId: queueItemId,",
                  "                outcomeNotes: null,",
                  "                contactValue: '0000000000',",
                  "                coversheetNotes: null,",
                  "                answers: scenarioConfig.answers || defaultAnswers,",
                  "                attachments: [],",
                  "                markAsFailed: false,",
                  "                includeAllAttachments: false",
                  "            }",
                  "        });",
                  "",
                  "        const refreshedTasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(refreshedTasksRes.code, 'refreshed tasks status').to.eql(200);",
                  "        const refreshedTasksJson = refreshedTasksRes.json();",
                  "        const refreshedTasks = Array.isArray(refreshedTasksJson.value) ? refreshedTasksJson.value : [];",
                  "        const eBenefitTask = refreshedTasks.find(task => ((task.taskName || '').trim() === 'e-Benefit Verification'));",
                  "        pm.expect(eBenefitTask, 'auto task e-benefit verification created').to.exist;",
                  "        const eBenefitId = eBenefitTask && eBenefitTask.id;",
                  "        pm.collectionVariables.set('autoTaskLastTaskId', eBenefitId);",
                  "",
                  "        const eBenefitRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/${eBenefitId}` });",
                  "        pm.expect(eBenefitRes.code, 'e-benefit task lookup status').to.eql(200);",
                  "        const eBenefitJson = eBenefitRes.json();",
                  "        const taskValue = eBenefitJson.value || {};",
                  "        pm.collectionVariables.set('autoTaskLastTaskResponse', JSON.stringify(taskValue));",
                  "",
                  "        const histories = Array.isArray(taskValue.externalApiRequestHistories) ? taskValue.externalApiRequestHistories : [];",
                  "        pm.expect(histories.length, 'external API request history entries').to.be.greaterThan(0);",
                  "",
                  "        const historyWithResponses = histories.filter(history => Array.isArray(history.responseHistory) && history.responseHistory.length);",
                  "        pm.expect(historyWithResponses.length, 'history entries with responses').to.be.greaterThan(0);",
                  "        const lastHistory = historyWithResponses[historyWithResponses.length - 1];",
                  "        const lastResponse = lastHistory.responseHistory[lastHistory.responseHistory.length - 1] || {};",
                  "        const responseText = lastResponse.response || '';",
                  "        let parsedResponse;",
                  "        try {",
                  "            parsedResponse = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;",
                  "        } catch (err) {",
                  "            parsedResponse = null;",
                  "        }",
                  "        const body = parsedResponse && parsedResponse.Body ? parsedResponse.Body : (parsedResponse || {});",
                  "        const coveragesSource = body.coverages || body.Coverages || body.coverage || body.Coverage || [];",
                  "        const coverages = Array.isArray(coveragesSource) ? coveragesSource : [];",
                  "        const normalizedCoverages = coverages.map(item => ({",
                  "            type: (item.coverageType || item.CoverageType || '').toString().toLowerCase(),",
                  "            insurance: (item.insurance || item.Insurance || '').toString().toLowerCase()",
                  "        }));",
                  "",
                  "        if (scenarioConfig.expectation && scenarioConfig.expectation.expectFailure) {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.eql('failed');",
                  "            pm.expect(coverages.length, 'coverages count for failed scenario').to.eql(0);",
                  "        } else {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.not.eql('failed');",
                  "            if (typeof scenarioConfig.expectation.expectedCoverageCount === 'number') {",
                  "                pm.expect(coverages.length, 'coverage count').to.eql(scenarioConfig.expectation.expectedCoverageCount);",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedCoverageTypes)) {",
                  "                scenarioConfig.expectation.expectedCoverageTypes.forEach(expectedType => {",
                  "                    const match = normalizedCoverages.some(item => item.type === expectedType.toLowerCase());",
                  "                    pm.expect(match, `coverage type ${expectedType} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedInsuranceNames) && scenarioConfig.expectation.expectedInsuranceNames.length) {",
                  "                scenarioConfig.expectation.expectedInsuranceNames.forEach(expectedName => {",
                  "                    const match = normalizedCoverages.some(item => item.insurance === expectedName.toLowerCase());",
                  "                    pm.expect(match, `insurance ${expectedName} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "        }",
                  "",
                  "        done();",
                  "    })().catch(error => {",
                  "        console.error('Auto task scenario execution failed', error);",
                  "        pm.expect.fail(error && error.message ? error.message : error);",
                  "        done();",
                  "    });",
                  "});",
                  ""
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "{{apiKey}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{autoTaskPrescriptionNumber}}\",\n    \"ndc\": \"{{autoTaskNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"10 mg\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{autoTaskPatientExternalId}},\n    \"firstName\": \"{{autoTaskPatientFirstName}}\",\n    \"lastName\": \"{{autoTaskPatientLastName}}\",\n    \"dateOfBirth\": \"1988-02-01T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{autoTaskPatientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\",\n        \"addressExtension\": \"Suite {{autoTaskSuffix}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{autoTaskPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{autoTaskPhysicianNpi}}\",\n    \"firstName\": \"Auto\",\n    \"lastName\": \"Prescriber{{autoTaskSuffix}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\"\n      }\n    ]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "caremetx",
                "prescription-integration"
              ]
            }
          },
          "response": []
        },
        {
          "name": "Multiple Coverages",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const expectation = {",
                  "        \"expectedCoverageCount\": 2,",
                  "        \"expectedCoverageTypes\": [",
                  "            \"primary\",",
                  "            \"secondary\"",
                  "        ],",
                  "        \"expectedInsuranceNames\": [],",
                  "        \"expectFailure\": false",
                  "    };",
                  "const scenarioConfig = {",
                  "    key: 'manyCoverages',",
                  "    firstName: 'Zod',",
                  "    expectation",
                  "};",
                  "",
                  "const timestamp = Date.now();",
                  "const suffix = timestamp.toString().slice(-5);",
                  "const randomId = Math.floor(Math.random() * 9000000) + 1000000;",
                  "const patientLastName = `Eligibility${suffix}`;",
                  "const patientEmail = `auto-task-${scenarioConfig.key}-${suffix}@example.com`;",
                  "const patientPhone = `502${(Math.floor(Math.random() * 9000000) + 1000000).toString().padStart(7, '0')}`;",
                  "const physicianNpi = `${Math.floor(Math.random() * 9000000000) + 1000000000}`;",
                  "const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Eligibility Way`;",
                  "const facilityZip = `${Math.floor(Math.random() * 90000) + 10000}`;",
                  "",
                  "pm.collectionVariables.set('autoTaskScenarioConfig', JSON.stringify(scenarioConfig));",
                  "pm.collectionVariables.set('autoTaskScenarioKey', scenarioConfig.key);",
                  "pm.collectionVariables.set('autoTaskSeedTimestamp', String(timestamp));",
                  "pm.collectionVariables.set('autoTaskSuffix', suffix);",
                  "",
                  "pm.collectionVariables.set('autoTaskPatientExternalId', String(randomId));",
                  "pm.collectionVariables.set('autoTaskPatientFirstName', scenarioConfig.firstName);",
                  "pm.collectionVariables.set('autoTaskPatientLastName', patientLastName);",
                  "pm.collectionVariables.set('autoTaskPatientEmail', patientEmail);",
                  "pm.collectionVariables.set('autoTaskPatientPhone', patientPhone);",
                  "pm.collectionVariables.set('autoTaskPhysicianNpi', physicianNpi);",
                  "pm.collectionVariables.set('autoTaskPrescriptionNumber', `RX-AUTO-${timestamp}`);",
                  "pm.collectionVariables.set('autoTaskNdc', `${Math.floor(Math.random() * 90000000000) + 10000000000}`);",
                  "pm.collectionVariables.set('autoTaskFacilityAddress1', facilityAddress1);",
                  "pm.collectionVariables.set('autoTaskFacilityCity', 'Louisville');",
                  "pm.collectionVariables.set('autoTaskFacilityState', 'KY');",
                  "pm.collectionVariables.set('autoTaskFacilityStateId', '21');",
                  "pm.collectionVariables.set('autoTaskFacilityZip', facilityZip);",
                  ""
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const scenarioConfigRaw = pm.collectionVariables.get('autoTaskScenarioConfig');",
                  "let scenarioConfig = {};",
                  "try {",
                  "    scenarioConfig = scenarioConfigRaw ? JSON.parse(scenarioConfigRaw) : {};",
                  "} catch (err) {",
                  "    console.error('Failed to parse scenario config', err);",
                  "    scenarioConfig = {};",
                  "}",
                  "const scenarioKey = scenarioConfig.key || 'unknown';",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - prescription intake accepted`, function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('value');",
                  "    pm.expect(json.value).to.have.property('caseId');",
                  "    pm.expect(json.success).to.eql(true);",
                  "});",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - completes verification flow`, function (done) {",
                  "    const responseJson = pm.response.json();",
                  "    const caseId = responseJson.value && responseJson.value.caseId;",
                  "    pm.collectionVariables.set('autoTaskCaseId', caseId);",
                  "    const baseUrl = pm.variables.replaceIn('{{base_url}}');",
                  "    const authToken = pm.variables.replaceIn('{{apiKey}}');",
                  "    if (!caseId) {",
                  "        pm.expect.fail('Case identifier missing from prescription intake response.');",
                  "        return done();",
                  "    }",
                  "    if (!baseUrl || !authToken) {",
                  "        pm.expect.fail('Environment variables base_url or apiKey are not configured.');",
                  "        return done();",
                  "    }",
                  "    const patientFirstName = pm.collectionVariables.get('autoTaskPatientFirstName');",
                  "    const patientLastName = pm.collectionVariables.get('autoTaskPatientLastName');",
                  "",
                  "    const toHeaderArray = (extraHeaders = {}) => {",
                  "        const headers = [",
                  "            { key: 'Authorization', value: authToken }",
                  "        ];",
                  "        Object.keys(extraHeaders).forEach(key => {",
                  "            headers.push({ key, value: extraHeaders[key] });",
                  "        });",
                  "        return headers;",
                  "    };",
                  "",
                  "    const send = (options) => new Promise((resolve, reject) => {",
                  "        const requestOptions = {",
                  "            url: options.url,",
                  "            method: options.method || 'GET',",
                  "            header: toHeaderArray(options.headers || {})",
                  "        };",
                  "        if (options.body !== undefined) {",
                  "            const rawBody = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);",
                  "            requestOptions.body = { mode: 'raw', raw: rawBody };",
                  "        }",
                  "        pm.sendRequest(requestOptions, (err, res) => {",
                  "            if (err) {",
                  "                reject(err);",
                  "                return;",
                  "            }",
                  "            if (!res) {",
                  "                reject(new Error('No response object returned.'));",
                  "                return;",
                  "            }",
                  "            resolve(res);",
                  "        });",
                  "    });",
                  "",
                  "    (async () => {",
                  "        const caseRes = await send({ url: `${baseUrl}/api/v1/Case/${caseId}` });",
                  "        pm.expect(caseRes.code, 'case lookup status').to.eql(200);",
                  "        const caseValue = caseRes.json().value || {};",
                  "        const patient = caseValue.patient || {};",
                  "        const patientId = patient.id;",
                  "        pm.collectionVariables.set('autoTaskPatientId', patientId);",
                  "        pm.expect(patientId, 'patient id from case lookup').to.exist;",
                  "",
                  "        const patchBody = [",
                  "            { op: 'replace', path: '/driversLicenseState', value: 'AK' },",
                  "            { op: 'replace', path: '/driversLicenseNumber', value: '33' },",
                  "            { op: 'replace', path: '/driversLicenseExpirationDate', value: '2028-11-02T00:00:00Z' }",
                  "        ];",
                  "        const patchRes = await send({",
                  "            url: `${baseUrl}/api/v1/Patients/json-patch/${patientId}`,",
                  "            method: 'PATCH',",
                  "            headers: { 'Content-Type': 'application/json-patch+json' },",
                  "            body: JSON.stringify(patchBody)",
                  "        });",
                  "        pm.expect(patchRes.code, 'patient patch status').to.be.oneOf([200, 204]);",
                  "",
                  "        const insuranceStateRes = await send({",
                  "            url: `${baseUrl}/api/v1/CaseInsurance/apply-insurance-state-changes`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                caseId: Number(caseId),",
                  "                patientHasInsurance: true",
                  "            }",
                  "        });",
                  "        pm.expect(insuranceStateRes.code, 'apply insurance state status').to.be.oneOf([200, 204]);",
                  "",
                  "        if (!scenarioConfig.expectation || scenarioConfig.expectation.skipPharmacyPlan !== true) {",
                  "            const planPayload = {",
                  "                planId: 18,",
                  "                caseId: Number(caseId),",
                  "                plan: {",
                  "                    id: 18,",
                  "                    isPBM: false,",
                  "                    name: 'Automation Insurance Plan',",
                  "                    address: {",
                  "                        streetAddress: null,",
                  "                        addressExtension: '',",
                  "                        zipCode: '81110',",
                  "                        city: 'Zymna',",
                  "                        state: 'KY',",
                  "                        countryId: null,",
                  "                        countryName: null",
                  "                    },",
                  "                    phone: '9787564444',",
                  "                    fax: '9787656453',",
                  "                    faxCountryIso2: null,",
                  "                    active: true,",
                  "                    specialtyPharmacyId: -9999,",
                  "                    specialtyPharmacyName: null,",
                  "                    externalSourcePharmacyBenefitPlanId: null,",
                  "                    typeId: 1,",
                  "                    typeName: 'Commercial',",
                  "                    subTypeId: 2,",
                  "                    subTypeName: 'Private/Commercial'",
                  "                },",
                  "                isAddNewInsurance: true,",
                  "                insurance: {",
                  "                    insurancePriorityId: 1,",
                  "                    coverageTypeId: 2,",
                  "                    effectiveFrom: '2025-11-02T00:00:00Z',",
                  "                    effectiveTo: '2028-11-02T00:00:00Z',",
                  "                    groupNumber: '443',",
                  "                    employerName: 'Employer John',",
                  "                    memberId: '555',",
                  "                    planNumber: '444',",
                  "                    patientId: patientId,",
                  "                    policyHolderName: `${patientFirstName} ${patientLastName}`.trim(),",
                  "                    bin: '888',",
                  "                    pcn: '999'",
                  "                }",
                  "            };",
                  "            const planRes = await send({",
                  "                url: `${baseUrl}/api/v1/PatientInsurance/updatePharmacyPlan`,",
                  "                method: 'PATCH',",
                  "                headers: { 'Content-Type': 'application/json' },",
                  "                body: planPayload",
                  "            });",
                  "            pm.expect(planRes.code, 'update pharmacy plan status').to.be.oneOf([200, 204]);",
                  "        }",
                  "",
                  "        const consentRes = await send({",
                  "            url: `${baseUrl}/api/v1/Consents`,",
                  "            method: 'PUT',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                consent: {",
                  "                    id: 0,",
                  "                    consentTypeId: 1,",
                  "                    consentIsOnFile: true,",
                  "                    consentMethod: 1,",
                  "                    dateReceived: '2025-11-02T00:00:00.000Z',",
                  "                    effectiveEndDate: '2028-12-02T00:00:00.000Z',",
                  "                    patientId: patientId",
                  "                }",
                  "            }",
                  "        });",
                  "        pm.expect(consentRes.code, 'consent status').to.be.oneOf([200, 204]);",
                  "",
                  "        const tasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(tasksRes.code, 'initial tasks status').to.eql(200);",
                  "        const tasksJson = tasksRes.json();",
                  "        const tasks = Array.isArray(tasksJson.value) ? tasksJson.value : [];",
                  "        const followUps = tasks.filter(task => ((task.taskName || '').trim() === 'Follow-up with Patient re: Missing Information'));",
                  "        pm.expect(followUps.length, 'available manual follow-up tasks').to.be.greaterThan(0);",
                  "        const latestFollowUp = followUps.reduce((latest, current) => (!latest || current.id > latest.id) ? current : latest, null);",
                  "        const queueItemId = latestFollowUp && latestFollowUp.id;",
                  "        pm.expect(queueItemId, 'queue item id for manual follow-up').to.exist;",
                  "",
                  "        const defaultAnswers = [",
                  "            { id: 812, answer: 'true', metadata: null, note: null, question: { id: 9001 }, chosenOptions: [] },",
                  "            { id: 813, answer: '[]', metadata: null, note: null, question: { id: 9002 }, chosenOptions: [] },",
                  "            { id: 814, answer: '', metadata: null, note: null, question: { id: 9003 }, chosenOptions: [] },",
                  "            { id: 815, answer: '', metadata: null, note: null, question: { id: 9004, options: [] }, chosenOptions: [] },",
                  "            { id: 816, answer: '', metadata: null, note: null, question: { id: 9005 }, chosenOptions: [] },",
                  "            { id: 817, answer: '', metadata: null, note: null, question: { id: 9006 }, chosenOptions: [] }",
                  "        ];",
                  "",
                  "        await send({",
                  "            url: `${baseUrl}/api/v1/workflow/complete-task`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                queueItemId: queueItemId,",
                  "                outcomeNotes: null,",
                  "                contactValue: '0000000000',",
                  "                coversheetNotes: null,",
                  "                answers: scenarioConfig.answers || defaultAnswers,",
                  "                attachments: [],",
                  "                markAsFailed: false,",
                  "                includeAllAttachments: false",
                  "            }",
                  "        });",
                  "",
                  "        const refreshedTasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(refreshedTasksRes.code, 'refreshed tasks status').to.eql(200);",
                  "        const refreshedTasksJson = refreshedTasksRes.json();",
                  "        const refreshedTasks = Array.isArray(refreshedTasksJson.value) ? refreshedTasksJson.value : [];",
                  "        const eBenefitTask = refreshedTasks.find(task => ((task.taskName || '').trim() === 'e-Benefit Verification'));",
                  "        pm.expect(eBenefitTask, 'auto task e-benefit verification created').to.exist;",
                  "        const eBenefitId = eBenefitTask && eBenefitTask.id;",
                  "        pm.collectionVariables.set('autoTaskLastTaskId', eBenefitId);",
                  "",
                  "        const eBenefitRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/${eBenefitId}` });",
                  "        pm.expect(eBenefitRes.code, 'e-benefit task lookup status').to.eql(200);",
                  "        const eBenefitJson = eBenefitRes.json();",
                  "        const taskValue = eBenefitJson.value || {};",
                  "        pm.collectionVariables.set('autoTaskLastTaskResponse', JSON.stringify(taskValue));",
                  "",
                  "        const histories = Array.isArray(taskValue.externalApiRequestHistories) ? taskValue.externalApiRequestHistories : [];",
                  "        pm.expect(histories.length, 'external API request history entries').to.be.greaterThan(0);",
                  "",
                  "        const historyWithResponses = histories.filter(history => Array.isArray(history.responseHistory) && history.responseHistory.length);",
                  "        pm.expect(historyWithResponses.length, 'history entries with responses').to.be.greaterThan(0);",
                  "        const lastHistory = historyWithResponses[historyWithResponses.length - 1];",
                  "        const lastResponse = lastHistory.responseHistory[lastHistory.responseHistory.length - 1] || {};",
                  "        const responseText = lastResponse.response || '';",
                  "        let parsedResponse;",
                  "        try {",
                  "            parsedResponse = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;",
                  "        } catch (err) {",
                  "            parsedResponse = null;",
                  "        }",
                  "        const body = parsedResponse && parsedResponse.Body ? parsedResponse.Body : (parsedResponse || {});",
                  "        const coveragesSource = body.coverages || body.Coverages || body.coverage || body.Coverage || [];",
                  "        const coverages = Array.isArray(coveragesSource) ? coveragesSource : [];",
                  "        const normalizedCoverages = coverages.map(item => ({",
                  "            type: (item.coverageType || item.CoverageType || '').toString().toLowerCase(),",
                  "            insurance: (item.insurance || item.Insurance || '').toString().toLowerCase()",
                  "        }));",
                  "",
                  "        if (scenarioConfig.expectation && scenarioConfig.expectation.expectFailure) {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.eql('failed');",
                  "            pm.expect(coverages.length, 'coverages count for failed scenario').to.eql(0);",
                  "        } else {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.not.eql('failed');",
                  "            if (typeof scenarioConfig.expectation.expectedCoverageCount === 'number') {",
                  "                pm.expect(coverages.length, 'coverage count').to.eql(scenarioConfig.expectation.expectedCoverageCount);",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedCoverageTypes)) {",
                  "                scenarioConfig.expectation.expectedCoverageTypes.forEach(expectedType => {",
                  "                    const match = normalizedCoverages.some(item => item.type === expectedType.toLowerCase());",
                  "                    pm.expect(match, `coverage type ${expectedType} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedInsuranceNames) && scenarioConfig.expectation.expectedInsuranceNames.length) {",
                  "                scenarioConfig.expectation.expectedInsuranceNames.forEach(expectedName => {",
                  "                    const match = normalizedCoverages.some(item => item.insurance === expectedName.toLowerCase());",
                  "                    pm.expect(match, `insurance ${expectedName} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "        }",
                  "",
                  "        done();",
                  "    })().catch(error => {",
                  "        console.error('Auto task scenario execution failed', error);",
                  "        pm.expect.fail(error && error.message ? error.message : error);",
                  "        done();",
                  "    });",
                  "});",
                  ""
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "{{apiKey}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{autoTaskPrescriptionNumber}}\",\n    \"ndc\": \"{{autoTaskNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"10 mg\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{autoTaskPatientExternalId}},\n    \"firstName\": \"{{autoTaskPatientFirstName}}\",\n    \"lastName\": \"{{autoTaskPatientLastName}}\",\n    \"dateOfBirth\": \"1988-02-01T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{autoTaskPatientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\",\n        \"addressExtension\": \"Suite {{autoTaskSuffix}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{autoTaskPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{autoTaskPhysicianNpi}}\",\n    \"firstName\": \"Auto\",\n    \"lastName\": \"Prescriber{{autoTaskSuffix}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\"\n      }\n    ]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "caremetx",
                "prescription-integration"
              ]
            }
          },
          "response": []
        },
        {
          "name": "External API Failure",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const expectation = {",
                  "        \"expectedCoverageCount\": 0,",
                  "        \"expectedCoverageTypes\": [],",
                  "        \"expectedInsuranceNames\": [],",
                  "        \"expectFailure\": true",
                  "    };",
                  "const scenarioConfig = {",
                  "    key: 'error',",
                  "    firstName: 'Error',",
                  "    expectation",
                  "};",
                  "",
                  "const timestamp = Date.now();",
                  "const suffix = timestamp.toString().slice(-5);",
                  "const randomId = Math.floor(Math.random() * 9000000) + 1000000;",
                  "const patientLastName = `Eligibility${suffix}`;",
                  "const patientEmail = `auto-task-${scenarioConfig.key}-${suffix}@example.com`;",
                  "const patientPhone = `502${(Math.floor(Math.random() * 9000000) + 1000000).toString().padStart(7, '0')}`;",
                  "const physicianNpi = `${Math.floor(Math.random() * 9000000000) + 1000000000}`;",
                  "const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Eligibility Way`;",
                  "const facilityZip = `${Math.floor(Math.random() * 90000) + 10000}`;",
                  "",
                  "pm.collectionVariables.set('autoTaskScenarioConfig', JSON.stringify(scenarioConfig));",
                  "pm.collectionVariables.set('autoTaskScenarioKey', scenarioConfig.key);",
                  "pm.collectionVariables.set('autoTaskSeedTimestamp', String(timestamp));",
                  "pm.collectionVariables.set('autoTaskSuffix', suffix);",
                  "",
                  "pm.collectionVariables.set('autoTaskPatientExternalId', String(randomId));",
                  "pm.collectionVariables.set('autoTaskPatientFirstName', scenarioConfig.firstName);",
                  "pm.collectionVariables.set('autoTaskPatientLastName', patientLastName);",
                  "pm.collectionVariables.set('autoTaskPatientEmail', patientEmail);",
                  "pm.collectionVariables.set('autoTaskPatientPhone', patientPhone);",
                  "pm.collectionVariables.set('autoTaskPhysicianNpi', physicianNpi);",
                  "pm.collectionVariables.set('autoTaskPrescriptionNumber', `RX-AUTO-${timestamp}`);",
                  "pm.collectionVariables.set('autoTaskNdc', `${Math.floor(Math.random() * 90000000000) + 10000000000}`);",
                  "pm.collectionVariables.set('autoTaskFacilityAddress1', facilityAddress1);",
                  "pm.collectionVariables.set('autoTaskFacilityCity', 'Louisville');",
                  "pm.collectionVariables.set('autoTaskFacilityState', 'KY');",
                  "pm.collectionVariables.set('autoTaskFacilityStateId', '21');",
                  "pm.collectionVariables.set('autoTaskFacilityZip', facilityZip);",
                  ""
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "const scenarioConfigRaw = pm.collectionVariables.get('autoTaskScenarioConfig');",
                  "let scenarioConfig = {};",
                  "try {",
                  "    scenarioConfig = scenarioConfigRaw ? JSON.parse(scenarioConfigRaw) : {};",
                  "} catch (err) {",
                  "    console.error('Failed to parse scenario config', err);",
                  "    scenarioConfig = {};",
                  "}",
                  "const scenarioKey = scenarioConfig.key || 'unknown';",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - prescription intake accepted`, function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('value');",
                  "    pm.expect(json.value).to.have.property('caseId');",
                  "    pm.expect(json.success).to.eql(true);",
                  "});",
                  "",
                  "pm.test(`Auto Task ${scenarioKey} - completes verification flow`, function (done) {",
                  "    const responseJson = pm.response.json();",
                  "    const caseId = responseJson.value && responseJson.value.caseId;",
                  "    pm.collectionVariables.set('autoTaskCaseId', caseId);",
                  "    const baseUrl = pm.variables.replaceIn('{{base_url}}');",
                  "    const authToken = pm.variables.replaceIn('{{apiKey}}');",
                  "    if (!caseId) {",
                  "        pm.expect.fail('Case identifier missing from prescription intake response.');",
                  "        return done();",
                  "    }",
                  "    if (!baseUrl || !authToken) {",
                  "        pm.expect.fail('Environment variables base_url or apiKey are not configured.');",
                  "        return done();",
                  "    }",
                  "    const patientFirstName = pm.collectionVariables.get('autoTaskPatientFirstName');",
                  "    const patientLastName = pm.collectionVariables.get('autoTaskPatientLastName');",
                  "",
                  "    const toHeaderArray = (extraHeaders = {}) => {",
                  "        const headers = [",
                  "            { key: 'Authorization', value: authToken }",
                  "        ];",
                  "        Object.keys(extraHeaders).forEach(key => {",
                  "            headers.push({ key, value: extraHeaders[key] });",
                  "        });",
                  "        return headers;",
                  "    };",
                  "",
                  "    const send = (options) => new Promise((resolve, reject) => {",
                  "        const requestOptions = {",
                  "            url: options.url,",
                  "            method: options.method || 'GET',",
                  "            header: toHeaderArray(options.headers || {})",
                  "        };",
                  "        if (options.body !== undefined) {",
                  "            const rawBody = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);",
                  "            requestOptions.body = { mode: 'raw', raw: rawBody };",
                  "        }",
                  "        pm.sendRequest(requestOptions, (err, res) => {",
                  "            if (err) {",
                  "                reject(err);",
                  "                return;",
                  "            }",
                  "            if (!res) {",
                  "                reject(new Error('No response object returned.'));",
                  "                return;",
                  "            }",
                  "            resolve(res);",
                  "        });",
                  "    });",
                  "",
                  "    (async () => {",
                  "        const caseRes = await send({ url: `${baseUrl}/api/v1/Case/${caseId}` });",
                  "        pm.expect(caseRes.code, 'case lookup status').to.eql(200);",
                  "        const caseValue = caseRes.json().value || {};",
                  "        const patient = caseValue.patient || {};",
                  "        const patientId = patient.id;",
                  "        pm.collectionVariables.set('autoTaskPatientId', patientId);",
                  "        pm.expect(patientId, 'patient id from case lookup').to.exist;",
                  "",
                  "        const patchBody = [",
                  "            { op: 'replace', path: '/driversLicenseState', value: 'AK' },",
                  "            { op: 'replace', path: '/driversLicenseNumber', value: '33' },",
                  "            { op: 'replace', path: '/driversLicenseExpirationDate', value: '2028-11-02T00:00:00Z' }",
                  "        ];",
                  "        const patchRes = await send({",
                  "            url: `${baseUrl}/api/v1/Patients/json-patch/${patientId}`,",
                  "            method: 'PATCH',",
                  "            headers: { 'Content-Type': 'application/json-patch+json' },",
                  "            body: JSON.stringify(patchBody)",
                  "        });",
                  "        pm.expect(patchRes.code, 'patient patch status').to.be.oneOf([200, 204]);",
                  "",
                  "        const insuranceStateRes = await send({",
                  "            url: `${baseUrl}/api/v1/CaseInsurance/apply-insurance-state-changes`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                caseId: Number(caseId),",
                  "                patientHasInsurance: true",
                  "            }",
                  "        });",
                  "        pm.expect(insuranceStateRes.code, 'apply insurance state status').to.be.oneOf([200, 204]);",
                  "",
                  "        if (!scenarioConfig.expectation || scenarioConfig.expectation.skipPharmacyPlan !== true) {",
                  "            const planPayload = {",
                  "                planId: 18,",
                  "                caseId: Number(caseId),",
                  "                plan: {",
                  "                    id: 18,",
                  "                    isPBM: false,",
                  "                    name: 'Automation Insurance Plan',",
                  "                    address: {",
                  "                        streetAddress: null,",
                  "                        addressExtension: '',",
                  "                        zipCode: '81110',",
                  "                        city: 'Zymna',",
                  "                        state: 'KY',",
                  "                        countryId: null,",
                  "                        countryName: null",
                  "                    },",
                  "                    phone: '9787564444',",
                  "                    fax: '9787656453',",
                  "                    faxCountryIso2: null,",
                  "                    active: true,",
                  "                    specialtyPharmacyId: -9999,",
                  "                    specialtyPharmacyName: null,",
                  "                    externalSourcePharmacyBenefitPlanId: null,",
                  "                    typeId: 1,",
                  "                    typeName: 'Commercial',",
                  "                    subTypeId: 2,",
                  "                    subTypeName: 'Private/Commercial'",
                  "                },",
                  "                isAddNewInsurance: true,",
                  "                insurance: {",
                  "                    insurancePriorityId: 1,",
                  "                    coverageTypeId: 2,",
                  "                    effectiveFrom: '2025-11-02T00:00:00Z',",
                  "                    effectiveTo: '2028-11-02T00:00:00Z',",
                  "                    groupNumber: '443',",
                  "                    employerName: 'Employer John',",
                  "                    memberId: '555',",
                  "                    planNumber: '444',",
                  "                    patientId: patientId,",
                  "                    policyHolderName: `${patientFirstName} ${patientLastName}`.trim(),",
                  "                    bin: '888',",
                  "                    pcn: '999'",
                  "                }",
                  "            };",
                  "            const planRes = await send({",
                  "                url: `${baseUrl}/api/v1/PatientInsurance/updatePharmacyPlan`,",
                  "                method: 'PATCH',",
                  "                headers: { 'Content-Type': 'application/json' },",
                  "                body: planPayload",
                  "            });",
                  "            pm.expect(planRes.code, 'update pharmacy plan status').to.be.oneOf([200, 204]);",
                  "        }",
                  "",
                  "        const consentRes = await send({",
                  "            url: `${baseUrl}/api/v1/Consents`,",
                  "            method: 'PUT',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                consent: {",
                  "                    id: 0,",
                  "                    consentTypeId: 1,",
                  "                    consentIsOnFile: true,",
                  "                    consentMethod: 1,",
                  "                    dateReceived: '2025-11-02T00:00:00.000Z',",
                  "                    effectiveEndDate: '2028-12-02T00:00:00.000Z',",
                  "                    patientId: patientId",
                  "                }",
                  "            }",
                  "        });",
                  "        pm.expect(consentRes.code, 'consent status').to.be.oneOf([200, 204]);",
                  "",
                  "        const tasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(tasksRes.code, 'initial tasks status').to.eql(200);",
                  "        const tasksJson = tasksRes.json();",
                  "        const tasks = Array.isArray(tasksJson.value) ? tasksJson.value : [];",
                  "        const followUps = tasks.filter(task => ((task.taskName || '').trim() === 'Follow-up with Patient re: Missing Information'));",
                  "        pm.expect(followUps.length, 'available manual follow-up tasks').to.be.greaterThan(0);",
                  "        const latestFollowUp = followUps.reduce((latest, current) => (!latest || current.id > latest.id) ? current : latest, null);",
                  "        const queueItemId = latestFollowUp && latestFollowUp.id;",
                  "        pm.expect(queueItemId, 'queue item id for manual follow-up').to.exist;",
                  "",
                  "        const defaultAnswers = [",
                  "            { id: 812, answer: 'true', metadata: null, note: null, question: { id: 9001 }, chosenOptions: [] },",
                  "            { id: 813, answer: '[]', metadata: null, note: null, question: { id: 9002 }, chosenOptions: [] },",
                  "            { id: 814, answer: '', metadata: null, note: null, question: { id: 9003 }, chosenOptions: [] },",
                  "            { id: 815, answer: '', metadata: null, note: null, question: { id: 9004, options: [] }, chosenOptions: [] },",
                  "            { id: 816, answer: '', metadata: null, note: null, question: { id: 9005 }, chosenOptions: [] },",
                  "            { id: 817, answer: '', metadata: null, note: null, question: { id: 9006 }, chosenOptions: [] }",
                  "        ];",
                  "",
                  "        await send({",
                  "            url: `${baseUrl}/api/v1/workflow/complete-task`,",
                  "            method: 'POST',",
                  "            headers: { 'Content-Type': 'application/json' },",
                  "            body: {",
                  "                queueItemId: queueItemId,",
                  "                outcomeNotes: null,",
                  "                contactValue: '0000000000',",
                  "                coversheetNotes: null,",
                  "                answers: scenarioConfig.answers || defaultAnswers,",
                  "                attachments: [],",
                  "                markAsFailed: false,",
                  "                includeAllAttachments: false",
                  "            }",
                  "        });",
                  "",
                  "        const refreshedTasksRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/for/${caseId}` });",
                  "        pm.expect(refreshedTasksRes.code, 'refreshed tasks status').to.eql(200);",
                  "        const refreshedTasksJson = refreshedTasksRes.json();",
                  "        const refreshedTasks = Array.isArray(refreshedTasksJson.value) ? refreshedTasksJson.value : [];",
                  "        const eBenefitTask = refreshedTasks.find(task => ((task.taskName || '').trim() === 'e-Benefit Verification'));",
                  "        pm.expect(eBenefitTask, 'auto task e-benefit verification created').to.exist;",
                  "        const eBenefitId = eBenefitTask && eBenefitTask.id;",
                  "        pm.collectionVariables.set('autoTaskLastTaskId', eBenefitId);",
                  "",
                  "        const eBenefitRes = await send({ url: `${baseUrl}/api/v1/CaseTasks/${eBenefitId}` });",
                  "        pm.expect(eBenefitRes.code, 'e-benefit task lookup status').to.eql(200);",
                  "        const eBenefitJson = eBenefitRes.json();",
                  "        const taskValue = eBenefitJson.value || {};",
                  "        pm.collectionVariables.set('autoTaskLastTaskResponse', JSON.stringify(taskValue));",
                  "",
                  "        const histories = Array.isArray(taskValue.externalApiRequestHistories) ? taskValue.externalApiRequestHistories : [];",
                  "        pm.expect(histories.length, 'external API request history entries').to.be.greaterThan(0);",
                  "",
                  "        const historyWithResponses = histories.filter(history => Array.isArray(history.responseHistory) && history.responseHistory.length);",
                  "        pm.expect(historyWithResponses.length, 'history entries with responses').to.be.greaterThan(0);",
                  "        const lastHistory = historyWithResponses[historyWithResponses.length - 1];",
                  "        const lastResponse = lastHistory.responseHistory[lastHistory.responseHistory.length - 1] || {};",
                  "        const responseText = lastResponse.response || '';",
                  "        let parsedResponse;",
                  "        try {",
                  "            parsedResponse = typeof responseText === 'string' ? JSON.parse(responseText) : responseText;",
                  "        } catch (err) {",
                  "            parsedResponse = null;",
                  "        }",
                  "        const body = parsedResponse && parsedResponse.Body ? parsedResponse.Body : (parsedResponse || {});",
                  "        const coveragesSource = body.coverages || body.Coverages || body.coverage || body.Coverage || [];",
                  "        const coverages = Array.isArray(coveragesSource) ? coveragesSource : [];",
                  "        const normalizedCoverages = coverages.map(item => ({",
                  "            type: (item.coverageType || item.CoverageType || '').toString().toLowerCase(),",
                  "            insurance: (item.insurance || item.Insurance || '').toString().toLowerCase()",
                  "        }));",
                  "",
                  "        if (scenarioConfig.expectation && scenarioConfig.expectation.expectFailure) {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.eql('failed');",
                  "            pm.expect(coverages.length, 'coverages count for failed scenario').to.eql(0);",
                  "        } else {",
                  "            pm.expect((lastHistory.status || '').toLowerCase()).to.not.eql('failed');",
                  "            if (typeof scenarioConfig.expectation.expectedCoverageCount === 'number') {",
                  "                pm.expect(coverages.length, 'coverage count').to.eql(scenarioConfig.expectation.expectedCoverageCount);",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedCoverageTypes)) {",
                  "                scenarioConfig.expectation.expectedCoverageTypes.forEach(expectedType => {",
                  "                    const match = normalizedCoverages.some(item => item.type === expectedType.toLowerCase());",
                  "                    pm.expect(match, `coverage type ${expectedType} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "            if (Array.isArray(scenarioConfig.expectation.expectedInsuranceNames) && scenarioConfig.expectation.expectedInsuranceNames.length) {",
                  "                scenarioConfig.expectation.expectedInsuranceNames.forEach(expectedName => {",
                  "                    const match = normalizedCoverages.some(item => item.insurance === expectedName.toLowerCase());",
                  "                    pm.expect(match, `insurance ${expectedName} present`).to.eql(true);",
                  "                });",
                  "            }",
                  "        }",
                  "",
                  "        done();",
                  "    })().catch(error => {",
                  "        console.error('Auto task scenario execution failed', error);",
                  "        pm.expect.fail(error && error.message ? error.message : error);",
                  "        done();",
                  "    });",
                  "});",
                  ""
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "{{apiKey}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{autoTaskPrescriptionNumber}}\",\n    \"ndc\": \"{{autoTaskNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"10 mg\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{autoTaskPatientExternalId}},\n    \"firstName\": \"{{autoTaskPatientFirstName}}\",\n    \"lastName\": \"{{autoTaskPatientLastName}}\",\n    \"dateOfBirth\": \"1988-02-01T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{autoTaskPatientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\",\n        \"addressExtension\": \"Suite {{autoTaskSuffix}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{autoTaskPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{autoTaskPhysicianNpi}}\",\n    \"firstName\": \"Auto\",\n    \"lastName\": \"Prescriber{{autoTaskSuffix}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{autoTaskFacilityAddress1}}\",\n        \"city\": \"{{autoTaskFacilityCity}}\",\n        \"state\": {{autoTaskFacilityStateId}},\n        \"zipCode\": \"{{autoTaskFacilityZip}}\"\n      }\n    ]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "v1",
                "caremetx",
                "prescription-integration"
              ]
            }
          },
          "response": []
        }
      ]
    }
  ]
}
