{
	"info": {
		"_postman_id": "499f9b23-9dab-4b55-9e32-dd5cf38f035f",
		"name": "Caremetx Prescription Integration",
		"description": "Automation helpers for exercising POST /api/v1/caremetx/prescription-integration plus lookup calls for downstream verification.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "19115467"
	},
	"item": [
		{
			"name": "Prescription Intake",
			"item": [
				{
					"name": "01 Unauthorized - Invalid API Key",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.request.headers.upsert({ key: 'Authorization', value: 'ApiKey ' + (pm.variables.get('invalidApiKey') || 'INVALID') });"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Unauthorized response returns 401', function () {",
									"    pm.expect(pm.response.code).to.eql(401);",
									"});",
									"if (pm.response.headers.has('Content-Type') && pm.response.headers.get('Content-Type').includes('json')) {",
									"    const json = pm.response.json();",
									"    pm.test('Unauthorized payload follows RFC 7807 format', function () {",
									"        pm.expect(json).to.include.keys('type', 'title', 'status');",
									"        pm.expect(json.status).to.eql(401);",
									"    });",
									"}"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"RX-UNAUTH\",\n    \"ndc\": \"11111111111\",\n    \"quantity\": 1\n  },\n  \"patient\": {\n    \"patientId\": 1001,\n    \"firstName\": \"Test\",\n    \"lastName\": \"User\",\n    \"dateOfBirth\": \"1980-01-01T00:00:00Z\",\n    \"phones\": [\n      {\n        \"number\": \"5025550100\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"1234567890\",\n    \"firstName\": \"Auth\",\n    \"lastName\": \"Check\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "02 New Prescription Ingestion",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"const seed = Date.now();",
									"const short = seed.toString().slice(-5);",
									"const patientId = Math.floor(Math.random() * 900000) + 100000;",
									"const patientFirst = `Auto${short}`;",
									"const patientLast = `Person${short}`;",
									"const patientPhone = (Math.floor(Math.random() * 9000000000) + 1000000000).toString();",
									"const physicianNpi = (Math.floor(Math.random() * 9000000000) + 1000000000).toString();",
									"const physicianFirst = `Phys${short}`;",
									"const physicianLast = `Owner${short}`;",
									"const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Integration Way`;",
									"const facilityCity = 'Louisville';",
									"const facilityState = 21;",
									"const facilityZip = (Math.floor(Math.random() * 90000) + 10000).toString();",
									"const facilityExtension = `Suite ${short}`;",
									"const prescriptionNumber = `RX-${seed}`;",
									"const ndc = (Math.floor(Math.random() * 90000000000) + 10000000000).toString();",
									"pm.collectionVariables.set('patientExternalId', patientId);",
									"pm.collectionVariables.set('patientFirstNameOriginal', patientFirst);",
									"pm.collectionVariables.set('patientLastNameOriginal', patientLast);",
									"pm.collectionVariables.set('patientFirstNameCurrent', patientFirst);",
									"pm.collectionVariables.set('patientLastNameCurrent', patientLast);",
									"pm.collectionVariables.set('patientPhonePrimary', patientPhone);",
									"pm.collectionVariables.set('patientEmail', `caremetx-qa+${short}@example.com`);",
									"pm.collectionVariables.set('physicianNpi', physicianNpi);",
									"pm.collectionVariables.set('physicianFirstNameOriginal', physicianFirst);",
									"pm.collectionVariables.set('physicianLastNameOriginal', physicianLast);",
									"pm.collectionVariables.set('physicianFirstNameCurrent', physicianFirst);",
									"pm.collectionVariables.set('physicianLastNameCurrent', physicianLast);",
									"pm.collectionVariables.set('facilityAddress1', facilityAddress1);",
									"pm.collectionVariables.set('facilityAddress1Current', facilityAddress1);",
									"pm.collectionVariables.set('facilityCity', facilityCity);",
									"pm.collectionVariables.set('facilityState', facilityState);",
									"pm.collectionVariables.set('facilityZip', facilityZip);",
									"pm.collectionVariables.set('facilityAddressExtensionOriginal', facilityExtension);",
									"pm.collectionVariables.set('facilityAddressExtensionCurrent', facilityExtension);",
									"pm.collectionVariables.set('prescriptionNumber', prescriptionNumber);",
									"pm.collectionVariables.set('prescriptionNdc', ndc);",
									"pm.collectionVariables.set('openCasePrescriptionNumber', `RX-CASE-${seed}`);",
									"pm.collectionVariables.set('multiAddressToken', short);"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status indicates creation success', function () {",
									"    pm.expect([200, 201]).to.include(pm.response.code);",
									"});",
									"const json = pm.response.json();",
									"const successSchema = {",
									"  type: 'object',",
									"  required: ['value', 'code', 'success', 'message'],",
									"  properties: {",
									"    value: {",
									"      type: 'object',",
									"      required: ['prescriptionId', 'caseId', 'success', 'message'],",
									"      properties: {",
									"        prescriptionId: { type: ['string', 'number'] },",
									"        caseId: { type: ['string', 'number'] },",
									"        success: { type: 'boolean' },",
									"        message: { type: 'string' }",
									"      }",
									"    },",
									"    code: { type: 'number' },",
									"    success: { type: 'boolean' },",
									"    message: { type: 'string' }",
									"  }",
									"};",
									"pm.test('Success response matches contract schema', function () {",
									"    pm.expect(tv4.validate(json, successSchema), JSON.stringify(tv4.error)).to.be.true;",
									"});",
									"pm.test('Envelope indicates success', function () {",
									"    pm.expect(json.success).to.eql(true);",
									"    pm.expect(json.code).to.be.oneOf([200, 201, 204]);",
									"});",
									"pm.collectionVariables.set('lastCaseId', json.value.caseId);",
									"pm.collectionVariables.set('lastPrescriptionId', json.value.prescriptionId);",
									"pm.collectionVariables.set('latestSuccessMessage', json.value.message);",
									"pm.test('Identifiers captured for downstream verification', function () {",
									"    pm.expect(pm.collectionVariables.get('lastCaseId')).to.exist;",
									"    pm.expect(pm.collectionVariables.get('lastPrescriptionId')).to.exist;",
									"});"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30,\n    \"dosage\": \"500 mg\",\n    \"refillsNumber\": 2,\n    \"fillsMade\": 0,\n    \"refillsRemaining\": 2,\n    \"dispenseAsWritten\": true,\n    \"physicianSignature\": true,\n    \"physicianSignatureDate\": \"2025-01-15T00:00:00Z\",\n    \"expirationDate\": \"2026-01-15T00:00:00Z\",\n    \"daysSupply\": 30,\n    \"lastDispenseDate\": \"2024-12-20T00:00:00Z\",\n    \"nextAvailableRefillDate\": \"2025-01-20T00:00:00Z\",\n    \"source\": \"Electronic\"\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\",\n    \"dateOfBirth\": \"1982-05-04T00:00:00Z\",\n    \"gender\": 1,\n    \"languageId\": -1,\n    \"email\": \"{{patientEmail}}\",\n    \"addresses\": [\n      {\n        \"type\": 0,\n        \"streetAddress\": \"{{facilityAddress1}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{facilityAddressExtensionCurrent}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"{{patientPhonePrimary}}\",\n        \"type\": 0,\n        \"extension\": \"\"\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\",\n    \"specialtyCode\": \"ENT\",\n    \"specialtyName\": \"Ear Nose Throat\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{facilityAddress1}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{facilityAddressExtensionCurrent}}\"\n      }\n    ],\n    \"phones\": [\n      {\n        \"number\": \"73319{{multiAddressToken}}\",\n        \"type\": 1,\n        \"extension\": \"\"\n      }\n    ]\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "03 Patient Update for Existing Prescription",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const suffix = '-' + (Math.floor(Math.random() * 900) + 100);",
									"const updatedFirst = pm.collectionVariables.get('patientFirstNameOriginal') + suffix;",
									"const updatedLast = pm.collectionVariables.get('patientLastNameOriginal') + suffix;",
									"pm.collectionVariables.set('patientFirstNameCurrent', updatedFirst);",
									"pm.collectionVariables.set('patientLastNameCurrent', updatedLast);",
									"pm.collectionVariables.set('patientEmail', `caremetx-qa+update${suffix.replace('-', '')}@example.com`);",
									"pm.collectionVariables.set('patientPhonePrimary', (Math.floor(Math.random() * 9000000000) + 1000000000).toString());"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Existing patient update succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"const json = pm.response.json();",
									"pm.test('Update response indicates success', function () {",
									"    pm.expect(json).to.include.keys('value', 'code', 'success', 'message');",
									"    pm.expect(json.success).to.eql(true);",
									"    pm.expect(json.value).to.be.an('object');",
									"});",
									"pm.test('Update response message reflects existing prescription handling', function () {",
									"    pm.expect(json.value.message.toLowerCase()).to.include.oneOf(['updated', 'already exists']);",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\",\n    \"dateOfBirth\": \"1982-05-04T00:00:00Z\",\n    \"gender\": 1,\n    \"email\": \"{{patientEmail}}\",\n    \"phones\": [\n      {\n        \"number\": \"{{patientPhonePrimary}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "04 Physician Update Should Be Ignored",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const suffix = '-' + (Math.floor(Math.random() * 90) + 10);",
									"pm.variables.set('physicianFirstNameAttempt', pm.collectionVariables.get('physicianFirstNameOriginal') + suffix);",
									"pm.variables.set('physicianLastNameAttempt', pm.collectionVariables.get('physicianLastNameOriginal') + suffix);"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Physician update attempt succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"const updateResponse = pm.response.json();",
									"pm.test('Physician update attempt response indicates no duplication', function () {",
									"    pm.expect(updateResponse).to.have.property('value');",
									"    const message = ((updateResponse.value && updateResponse.value.message) || '').toString().toLowerCase();",
									"    pm.expect(['already exists', 'unchanged', 'updated'].some(function (keyword) { return message.includes(keyword); })).to.be.true;",
									"});",
									"const baseUrl = pm.variables.replaceIn('{{base_url}}');",
									"if (!baseUrl || baseUrl.includes('{{')) {",
									"    console.warn('base_url variable is not resolved; skipping physician verification lookup.');",
									"    return;",
									"}",
									"const npi = pm.collectionVariables.get('physicianNpi') || pm.collectionVariables.get('physicianNpiExisting') || '1234567464';",
									"const authHeader = pm.variables.replaceIn('ApiKey {{apiKey}}');",
									"if (!authHeader || authHeader.includes('{{')) {",
									"    console.warn('apiKey variable is not resolved; skipping physician verification lookup.');",
									"    return;",
									"}",
									"pm.sendRequest({",
									"    url: `${baseUrl}/api/v1/Physicians/getByNPI?npi=${encodeURIComponent(npi)}`,",
									"    method: 'GET',",
									"    header: { Authorization: authHeader }",
									"}, function (err, res) {",
									"    pm.test('Physician lookup after update attempt succeeds', function () {",
									"        pm.expect(err).to.eql(null);",
									"        pm.expect(res).to.be.an('object');",
									"        pm.expect(res.code).to.eql(200);",
									"    });",
									"    if (err || !res) {",
									"        return;",
									"    }",
									"    const lookup = res.json();",
									"    const value = lookup && lookup.value ? lookup.value : {};",
									"    pm.collectionVariables.set('physicianFirstNameCurrent', value.firstName || pm.collectionVariables.get('physicianFirstNameCurrent') || '');",
									"    pm.collectionVariables.set('physicianLastNameCurrent', value.lastName || pm.collectionVariables.get('physicianLastNameCurrent') || '');",
									"    pm.test('Physician names remain unchanged after update attempt', function () {",
									"        pm.expect(value.firstName).to.eql(pm.collectionVariables.get('physicianFirstNameOriginal'));",
									"        pm.expect(value.lastName).to.eql(pm.collectionVariables.get('physicianLastNameOriginal'));",
									"    });",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameAttempt}}\",\n    \"lastName\": \"{{physicianLastNameAttempt}}\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "05 Existing Facility Secondary Field Update",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const extension = `Suite ${Math.floor(Math.random() * 900) + 100}`;",
									"pm.variables.set('facilityExtensionAttempt', extension);"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Facility update returns success', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"const json = pm.response.json();",
									"pm.test('Facility update response indicates success', function () {",
									"    pm.expect(json.success).to.eql(true);",
									"});",
									"pm.collectionVariables.set('facilityAddressExtensionCurrent', pm.variables.get('facilityExtensionAttempt'));"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{facilityAddress1}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{facilityExtensionAttempt}}\"\n      }\n    ]\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "06 New Prescription With Existing Open Case",
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Open case conflict returns 400', function () {",
									"    pm.expect(pm.response.code).to.eql(400);",
									"});",
									"const json = pm.response.json();",
									"pm.test('Open case error structure matches expected contract', function () {",
									"    pm.expect(json).to.include.keys('errors', 'code', 'success', 'message');",
									"    pm.expect(json.code).to.eql(400);",
									"    pm.expect(json.success).to.eql(false);",
									"    pm.expect(json.errors).to.have.property('message');",
									"    pm.expect(json.errors.message).to.be.an('array').that.is.not.empty;",
									"});",
									"pm.test('Open case error explains existing open case restriction', function () {",
									"    const messageText = Array.isArray(json.errors.message) ? json.errors.message.join(' ') : String(json.errors.message || '');",
									"    pm.expect(messageText.toLowerCase()).to.include('already has an open case');",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{openCasePrescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "07 Duplicate Prescription Handling",
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Duplicate submission succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"const json = pm.response.json();",
									"pm.test('Duplicate response indicates existing prescription reuse', function () {",
									"    pm.expect(json.value.message.toLowerCase()).to.include('already exists');",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "08 Missing Required Fields",
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Missing required fields return 400', function () {",
									"    pm.expect(pm.response.code).to.eql(400);",
									"});",
									"const json = pm.response.json();",
									"const errorSchema = {",
									"  type: 'object',",
									"  required: ['type', 'title', 'status', 'traceId', 'errors'],",
									"  properties: {",
									"    type: { type: 'string' },",
									"    title: { type: 'string' },",
									"    status: { type: 'number' },",
									"    traceId: { type: 'string' },",
									"    errors: { type: 'object' }",
									"  }",
									"};",
									"pm.test('Validation error matches RFC 7807 schema', function () {",
									"    pm.expect(tv4.validate(json, errorSchema), JSON.stringify(tv4.error)).to.be.true;",
									"});",
									"pm.test('Error payload highlights missing patient last name', function () {",
									"    pm.expect(json.errors['Patient.LastName'][0].toLowerCase()).to.include('required');",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 30\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "09 Required Fields Only",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const stamp = Date.now().toString();",
									"pm.variables.set('minimalPrescriptionNumber', `RX-MIN-${stamp}`);",
									"pm.variables.set('minimalPrescriptionNdc', (Math.floor(Math.random() * 90000000000) + 10000000000).toString());",
									"pm.variables.set('minimalPatientId', Math.floor(Math.random() * 900000) + 100000);",
									"pm.variables.set('minimalPatientFirstName', `Min${stamp.slice(-4)}`);",
									"pm.variables.set('minimalPatientLastName', `Req${stamp.slice(-4)}`);",
									"pm.variables.set('minimalPatientPhone', (Math.floor(Math.random() * 9000000000) + 1000000000).toString());",
									"pm.variables.set('minimalPhysicianNpi', (Math.floor(Math.random() * 9000000000) + 1000000000).toString());",
									"pm.variables.set('minimalPhysicianFirstName', `MiniPhys${stamp.slice(-3)}`);",
									"pm.variables.set('minimalPhysicianLastName', `Check${stamp.slice(-3)}`);"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test('Minimal payload succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"const json = pm.response.json();",
									"pm.test('Minimal payload response indicates success', function () {",
									"    pm.expect(json.success).to.eql(true);",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{minimalPrescriptionNumber}}\",\n    \"ndc\": \"{{minimalPrescriptionNdc}}\",\n    \"quantity\": 1\n  },\n  \"patient\": {\n    \"patientId\": {{minimalPatientId}},\n    \"firstName\": \"{{minimalPatientFirstName}}\",\n    \"lastName\": \"{{minimalPatientLastName}}\",\n    \"dateOfBirth\": \"1982-05-04T00:00:00Z\",\n    \"phones\": [\n      {\n        \"number\": \"{{minimalPatientPhone}}\",\n        \"type\": 0\n      }\n    ]\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{minimalPhysicianNpi}}\",\n    \"firstName\": \"{{minimalPhysicianFirstName}}\",\n    \"lastName\": \"{{minimalPhysicianLastName}}\"\n  }\n}\n"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "10 Facility Association to Physician",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const seed = Date.now();",
									"const facilityAddress1 = `${Math.floor(Math.random() * 900) + 100} Assoc Ave`;",
									"const facilityExtension = `Floor ${Math.floor(Math.random() * 9) + 1}`;",
									"pm.variables.set('associationFacilityAddress1', facilityAddress1);",
									"pm.variables.set('associationFacilityExtension', facilityExtension);"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const baseUrl = pm.variables.replaceIn('{{base_url}}');",
									"const apiKey = pm.variables.get('apiKey');",
									"const npi = pm.variables.get('physicianNpi');",
									"const associationAddress1 = pm.variables.get('associationFacilityAddress1');",
									"const associationExtension = pm.variables.get('associationFacilityExtension');",
									"pm.test('Facility association call succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"if (!baseUrl || !apiKey || !npi) {",
									"    console.warn('Skipping physician lookup validation - missing baseUrl, apiKey, or physicianNpi variable.');",
									"    return;",
									"}",
									"pm.sendRequest({",
									"    url: `${baseUrl}/api/v1/physicians`,",
									"    method: 'POST',",
									"    header: {",
									"        'Content-Type': 'application/json',",
									"        'Authorization': `ApiKey ${apiKey}`",
									"    },",
									"    body: {",
									"        mode: 'raw',",
									"        raw: JSON.stringify({",
									"            skip: 0,",
									"            take: 15,",
									"            search: npi,",
									"            orderBy: 'string',",
									"            programId: Number(pm.variables.get('programId')) || 0,",
									"            facilityId: 0,",
									"            onlyActiveOffices: true,",
									"            excludedPhysiciansId: [0]",
									"        })",
									"    }",
									"}, function (err, res) {",
									"    pm.test('Physician facility lookup succeeded', function () {",
									"        pm.expect(err, 'Unexpected error from physician lookup').to.be.null;",
									"        pm.expect(res, 'Physician lookup response missing').to.exist;",
									"        if (res) {",
									"            pm.expect(res.code).to.eql(200);",
									"        }",
									"    });",
									"    if (err || !res) {",
									"        return;",
									"    }",
									"    const payload = res.json();",
									"    const first = payload && payload.value && payload.value[0];",
									"    const addresses = Array.isArray(first && first.addresses) ? first.addresses : [];",
									"    const matched = addresses.find(addr => addr && addr.address1 === associationAddress1 && (!associationExtension || addr.address2 === associationExtension));",
									"    pm.test('New facility address present for physician', function () {",
									"        pm.expect(matched, 'Expected newly associated facility to be returned by physician search').to.exist;",
									"    });",
									"    if (matched) {",
									"        pm.collectionVariables.set('facilityAddress1Current', matched.address1 || associationAddress1);",
									"        pm.collectionVariables.set('facilityAddressExtensionCurrent', matched.address2 || associationExtension || '');",
									"    }",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 15\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Association Office\",\n        \"streetAddress\": \"{{associationFacilityAddress1}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{associationFacilityExtension}}\"\n      }\n    ]\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "11 Multiple Physician Addresses",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const token = pm.collectionVariables.get('multiAddressToken') || Date.now().toString().slice(-5);",
									"pm.variables.set('multiAddressOne', `${Math.floor(Math.random() * 900) + 100} Multi Blvd`);",
									"pm.variables.set('multiAddressTwo', `${Math.floor(Math.random() * 900) + 100} Multi Ct`);",
									"pm.variables.set('multiExtensionOne', `Suite ${token}`);",
									"pm.variables.set('multiExtensionTwo', `Floor ${token}`);"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"const baseUrl = pm.variables.replaceIn('{{base_url}}');",
									"const apiKey = pm.variables.get('apiKey');",
									"const npi = pm.variables.get('physicianNpi');",
									"const primaryAddress = pm.collectionVariables.get('facilityAddress1Current');",
									"const primaryExtension = pm.collectionVariables.get('facilityAddressExtensionCurrent');",
									"const satelliteAddress = pm.variables.get('multiAddressTwo');",
									"const satelliteExtension = pm.variables.get('multiExtensionTwo');",
									"pm.test('Multiple address submission succeeds', function () {",
									"    pm.expect([200, 204]).to.include(pm.response.code);",
									"});",
									"if (!baseUrl || !apiKey || !npi) {",
									"    console.warn('Skipping multi-address verification - missing baseUrl, apiKey, or physicianNpi.');",
									"    return;",
									"}",
									"pm.sendRequest({",
									"    url: `${baseUrl}/api/v1/physicians`,",
									"    method: 'POST',",
									"    header: {",
									"        'Content-Type': 'application/json',",
									"        'Authorization': `ApiKey ${apiKey}`",
									"    },",
									"    body: {",
									"        mode: 'raw',",
									"        raw: JSON.stringify({",
									"            skip: 0,",
									"            take: 15,",
									"            search: npi,",
									"            orderBy: 'string',",
									"            programId: Number(pm.variables.get('programId')) || 0,",
									"            facilityId: 0,",
									"            onlyActiveOffices: true,",
									"            excludedPhysiciansId: [0]",
									"        })",
									"    }",
									"}, function (err, res) {",
									"    pm.test('Physician lookup for multi-address verification succeeded', function () {",
									"        pm.expect(err, 'Unexpected error from physician lookup').to.be.null;",
									"        pm.expect(res, 'Physician lookup response missing').to.exist;",
									"        if (res) {",
									"            pm.expect(res.code).to.eql(200);",
									"        }",
									"    });",
									"    if (err || !res) {",
									"        return;",
									"    }",
									"    const payload = res.json();",
									"    const first = payload && payload.value && payload.value[0];",
									"    const addresses = Array.isArray(first && first.addresses) ? first.addresses : [];",
									"    pm.test('Primary facility remains associated', function () {",
									"        const primary = addresses.find(addr => addr && addr.address1 === primaryAddress && (!primaryExtension || addr.address2 === primaryExtension));",
									"        pm.expect(primary, 'Expected existing primary facility to remain associated').to.exist;",
									"    });",
									"    pm.test('Additional facility captured for physician', function () {",
									"        const secondary = addresses.find(addr => addr && addr.address1 === satelliteAddress && (!satelliteExtension || addr.address2 === satelliteExtension));",
									"        pm.expect(secondary, 'Expected secondary facility to be returned by physician search').to.exist;",
									"    });",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": {\n    \"prescriptionNumber\": \"{{prescriptionNumber}}\",\n    \"ndc\": \"{{prescriptionNdc}}\",\n    \"quantity\": 10\n  },\n  \"patient\": {\n    \"patientId\": {{patientExternalId}},\n    \"firstName\": \"{{patientFirstNameCurrent}}\",\n    \"lastName\": \"{{patientLastNameCurrent}}\"\n  },\n  \"physician\": {\n    \"npiNumber\": \"{{physicianNpi}}\",\n    \"firstName\": \"{{physicianFirstNameCurrent}}\",\n    \"lastName\": \"{{physicianLastNameCurrent}}\",\n    \"addresses\": [\n      {\n        \"name\": \"Primary Office\",\n        \"streetAddress\": \"{{facilityAddress1Current}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{facilityAddressExtensionCurrent}}\"\n      },\n      {\n        \"name\": \"Satellite\",\n        \"streetAddress\": \"{{multiAddressTwo}}\",\n        \"city\": \"{{facilityCity}}\",\n        \"state\": {{facilityState}},\n        \"zipCode\": \"{{facilityZip}}\",\n        \"addressExtension\": \"{{multiExtensionTwo}}\"\n      }\n    ]\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				},
				{
					"name": "12 Error Response Schema Validation",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Validation error returns 400', function () {",
									"    pm.expect(pm.response.code).to.eql(400);",
									"});",
									"const json = pm.response.json();",
									"const errorSchema = {",
									"  type: 'object',",
									"  required: ['type', 'title', 'status', 'traceId', 'errors'],",
									"  properties: {",
									"    type: { type: 'string' },",
									"    title: { type: 'string' },",
									"    status: { type: 'number' },",
									"    traceId: { type: 'string' },",
									"    errors: { type: 'object' }",
									"  }",
									"};",
									"pm.test('Error payload validates against schema', function () {",
									"    pm.expect(tv4.validate(json, errorSchema), JSON.stringify(tv4.error)).to.be.true;",
									"});",
									"pm.test('Error payload lists missing top-level sections', function () {",
									"    pm.expect(Object.keys(json.errors)).to.include.members(['Patient.LastName', 'Patient.FirstName', 'Physician.LastName', 'Physician.FirstName', 'Physician.NPINumber', 'Prescription.NDC', 'Prescription.Quantity', 'Prescription.PrescriptionNumber']);",
									"});"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "ApiKey {{apiKey}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"clientId\": {{clientId}},\n  \"programId\": {{programId}},\n  \"prescription\": { },\n  \"patient\": { },\n  \"physician\": { }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/v1/caremetx/prescription-integration",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"caremetx",
								"prescription-integration"
							]
						}
					},
					"response": []
				}
			],
			"description": "Scenario-specific POST requests for /api/v1/caremetx/prescription-integration covering happy path, validation, and data maintenance behaviors."
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "https://example.p3.api"
		},
		{
			"key": "apiKey",
			"value": "{{PLACEHOLDER_VALID_API_KEY}}"
		},
		{
			"key": "invalidApiKey",
			"value": "INVALID-KEY"
		},
		{
			"key": "clientId",
			"value": "1"
		},
		{
			"key": "programId",
			"value": "1"
		},
		{
			"key": "patientExternalId",
			"value": ""
		},
		{
			"key": "patientFirstNameOriginal",
			"value": ""
		},
		{
			"key": "patientLastNameOriginal",
			"value": ""
		},
		{
			"key": "patientFirstNameCurrent",
			"value": ""
		},
		{
			"key": "patientLastNameCurrent",
			"value": ""
		},
		{
			"key": "patientPhonePrimary",
			"value": ""
		},
		{
			"key": "patientEmail",
			"value": ""
		},
		{
			"key": "physicianNpi",
			"value": ""
		},
		{
			"key": "physicianFirstNameOriginal",
			"value": ""
		},
		{
			"key": "physicianLastNameOriginal",
			"value": ""
		},
		{
			"key": "physicianFirstNameCurrent",
			"value": ""
		},
		{
			"key": "physicianLastNameCurrent",
			"value": ""
		},
		{
			"key": "facilityAddress1",
			"value": ""
		},
		{
			"key": "facilityAddress1Current",
			"value": ""
		},
		{
			"key": "facilityCity",
			"value": ""
		},
		{
			"key": "facilityState",
			"value": ""
		},
		{
			"key": "facilityZip",
			"value": ""
		},
		{
			"key": "facilityAddressExtensionOriginal",
			"value": ""
		},
		{
			"key": "facilityAddressExtensionCurrent",
			"value": ""
		},
		{
			"key": "prescriptionNumber",
			"value": ""
		},
		{
			"key": "prescriptionNdc",
			"value": ""
		},
		{
			"key": "openCasePrescriptionNumber",
			"value": ""
		},
		{
			"key": "multiAddressToken",
			"value": ""
		},
		{
			"key": "lastCaseId",
			"value": ""
		},
		{
			"key": "lastPrescriptionId",
			"value": ""
		},
		{
			"key": "latestSuccessMessage",
			"value": ""
		}
	]
}
